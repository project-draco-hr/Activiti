{
  ExecutionEntity subProcessInstance=newExecution();
  subProcessInstance.setSuperExecution(this);
  this.setSubProcessInstance(subProcessInstance);
  subProcessInstance.setProcessDefinition((ProcessDefinitionImpl)processDefinition);
  subProcessInstance.setProcessInstance(subProcessInstance);
  CommandContext commandContext=CommandContext.getCurrent();
  int historyLevel=commandContext.getProcessEngineConfiguration().getHistoryLevel();
  if (historyLevel >= ProcessEngineConfigurationImpl.HISTORYLEVEL_ACTIVITY) {
    DbSqlSession dbSqlSession=commandContext.getSession(DbSqlSession.class);
    HistoricProcessInstanceEntity historicProcessInstance=new HistoricProcessInstanceEntity((ExecutionEntity)subProcessInstance);
    dbSqlSession.insert(historicProcessInstance);
  }
  return subProcessInstance;
}
