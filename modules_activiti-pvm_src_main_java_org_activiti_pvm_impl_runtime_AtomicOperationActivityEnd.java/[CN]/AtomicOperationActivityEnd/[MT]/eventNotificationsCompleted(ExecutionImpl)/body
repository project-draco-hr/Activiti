{
  ActivityImpl activity=execution.getActivity();
  ActivityImpl parentActivity=activity.getParentActivity();
  if (execution.isProcessInstance()) {
    execution.performOperation(PROCESS_END);
  }
 else   if (!execution.isConcurrent()) {
    if (!activity.isScope()) {
      execution.setActivity(parentActivity);
      execution.performOperation(ACTIVITY_END);
    }
 else {
      ExecutionImpl parent=execution.getParent();
      execution.destroy();
      execution.remove();
      if (parentActivity != null) {
        parent.setActivity(parentActivity);
        parent.performOperation(ACTIVITY_END);
      }
 else {
        parent.performOperation(PROCESS_END);
      }
    }
  }
 else   if (execution.isScope() && !activity.isScope()) {
    execution.setActivity(parentActivity);
    execution.performOperation(ACTIVITY_END);
  }
 else {
    if (execution.isScope()) {
      execution.destroy();
    }
    if (parentActivity != null && !parentActivity.isScope() && (isExecutionAloneInParent(execution))) {
      execution.setActivity(parentActivity);
      execution.performOperation(ACTIVITY_END);
    }
 else {
      execution.remove();
      ExecutionImpl concurrentRoot=execution.getParent();
      if (concurrentRoot.getExecutions().size() == 1) {
        ExecutionImpl lastConcurrent=concurrentRoot.getExecutions().get(0);
        concurrentRoot.setActivity(lastConcurrent.getActivity());
        lastConcurrent.remove();
      }
    }
  }
}
