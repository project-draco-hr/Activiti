{
  ActivityImpl activity=execution.getActivity();
  ActivityImpl parentActivity=activity.getParentActivity();
  if (execution.isProcessInstance()) {
    execution.performOperation(PROCESS_END);
  }
 else   if (!execution.isConcurrent()) {
    if (parentActivity.isScope()) {
      ActivityBehavior parentActivityBehavior=parentActivity.getActivityBehavior();
      if (parentActivityBehavior instanceof CompositeActivityBehavior) {
        execution.setActivity(parentActivity);
        CompositeActivityBehavior compositeActivityBehavior=(CompositeActivityBehavior)parentActivityBehavior;
        compositeActivityBehavior.lastExecutionEnded(execution);
      }
 else {
        ExecutionImpl parentScopeExecution=execution.getParent();
        execution.destroy();
        execution.remove();
        parentScopeExecution.performOperation(ACTIVITY_END);
      }
    }
 else {
      execution.setActivity(parentActivity);
      execution.performOperation(ACTIVITY_END);
    }
  }
 else   if (execution.isScope() && !activity.isScope()) {
    execution.setActivity(parentActivity);
    execution.performOperation(ACTIVITY_END);
  }
 else {
    if (execution.isScope()) {
      execution.destroy();
    }
    if (parentActivity != null && !parentActivity.isScope() && (isExecutionAloneInParent(execution))) {
      execution.setActivity(parentActivity);
      execution.performOperation(ACTIVITY_END);
    }
 else {
      execution.remove();
      ExecutionImpl concurrentRoot=execution.getParent();
      if (concurrentRoot.getExecutions().size() == 1) {
        ExecutionImpl lastConcurrent=concurrentRoot.getExecutions().get(0);
        concurrentRoot.setActivity(lastConcurrent.getActivity());
        lastConcurrent.remove();
      }
 else       if (concurrentRoot.getExecutions().isEmpty()) {
        ActivityBehavior parentActivityBehavior=parentActivity.getActivityBehavior();
        if (parentActivityBehavior instanceof CompositeActivityBehavior) {
          CompositeActivityBehavior compositeActivityBehavior=(CompositeActivityBehavior)parentActivityBehavior;
          compositeActivityBehavior.lastExecutionEnded(execution);
        }
      }
    }
  }
}
