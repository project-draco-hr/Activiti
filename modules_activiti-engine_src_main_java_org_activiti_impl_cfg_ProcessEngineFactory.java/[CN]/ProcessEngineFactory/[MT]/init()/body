{
  if (initialized) {
    return;
  }
synchronized (lock) {
    if (!initialized) {
      ExpressionManager expressionManager=createDefaultExpressionManager();
      if (elResolver != null) {
        expressionManager.setElResolver(elResolver);
      }
      ScriptingEngines scriptingEngines=createDefaultScriptingEngines();
      BusinessCalendarManager businessCalendarManager=createDefaultBusinessCalendarManager();
      variableTypes=variableTypes == null ? createDefaultVariableTypes() : variableTypes;
      dbSchemaStrategy=dbSchemaStrategy == null ? createDefaultDbSchemaStrategy() : dbSchemaStrategy;
      JobHandlers jobHandlers=createDefaultJobHandlers();
      DeployerManager deployerManager=createDefaultDeployerManager(expressionManager,scriptingEngines,businessCalendarManager);
      commandExecutor=createDefaultCmdExecutor(this.commandContextFactory);
      processEventBus=processEventBus == null ? createDefaultProcessEventBus() : processEventBus;
      jobExecutor=jobExecutor == null ? createDefaultJobExecutor(commandExecutor,jobHandlers,jobExecutorAutoActivate) : jobExecutor;
      historicDataService=historicDataService == null ? createDefaultHistoricDataService(commandExecutor,processEventBus) : historicDataService;
      idGenerator=idGenerator == null ? createDefaultIdGenerator(commandExecutor) : idGenerator;
      identityService=identityService == null ? createDefaultIdentityService(commandExecutor) : identityService;
      ProcessServiceImpl processService=createDefaultProcessService(commandExecutor,deployerManager,scriptingEngines);
      TaskServiceImpl taskService=createDefaultTaskService(commandExecutor,scriptingEngines);
      ManagementServiceImpl managementService=createDefaultManagementService(commandExecutor);
      IbatisPersistenceSessionFactory ibatisPersistenceSessionFactory=new IbatisPersistenceSessionFactory(variableTypes,idGenerator,databaseName,dataSource,localTransactions);
      CachingPersistenceSessionFactory cachingPersistenceSessionFactory=new CachingPersistenceSessionFactory(ibatisPersistenceSessionFactory,deployerManager,Thread.currentThread().getContextClassLoader());
      commandContextFactory.setTransactionContextFactory(createDefaultTransactionContextFactory());
      Map<Class<?>,SessionFactory> sessionFactories=new HashMap<Class<?>,SessionFactory>();
      sessionFactories.put(MessageSession.class,new JobExecutorMessageSessionFactory());
      sessionFactories.put(TimerSession.class,new JobExecutorTimerSessionFactory());
      sessionFactories.put(PersistenceSession.class,cachingPersistenceSessionFactory);
      sessionFactories.put(RepositorySession.class,new DbRepositorySessionFactory());
      sessionFactories.put(DbSqlSession.class,new DbSqlSessionFactory(ibatisPersistenceSessionFactory.getSqlSessionFactory(),idGenerator,databaseName));
      configuration.setCommandContextFactory(commandContextFactory);
      configuration.setCommandExecutor(commandExecutor);
      configuration.setDbSchemaStrategy(dbSchemaStrategy);
      configuration.setDeployerManager(deployerManager);
      configuration.setHistoricDataService(historicDataService);
      configuration.setIdentityService(identityService);
      configuration.setIdGenerator(idGenerator);
      configuration.setJobExecutor(jobExecutor);
      configuration.setJobHandlers(jobHandlers);
      configuration.setManagementService(managementService);
      configuration.setPersistenceSessionFactory(cachingPersistenceSessionFactory);
      configuration.setProcessEngineName(processEngineName);
      configuration.setProcessEventBus(processEventBus);
      configuration.setProcessService(processService);
      configuration.setTaskService(taskService);
      configuration.setVariableTypes(variableTypes);
      configuration.setSessionFactories(sessionFactories);
      commandContextFactory.setProcessEngineConfiguration(configuration);
      initialized=true;
    }
  }
}
