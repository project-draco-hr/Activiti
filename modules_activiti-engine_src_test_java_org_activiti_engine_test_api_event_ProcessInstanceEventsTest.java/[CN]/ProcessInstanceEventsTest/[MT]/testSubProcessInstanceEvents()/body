{
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("nestedSimpleSubProcess");
  assertNotNull(processInstance);
  assertEquals(8,listener.getEventsReceived().size());
  assertTrue(listener.getEventsReceived().get(0) instanceof ActivitiEntityEvent);
  ActivitiEntityEvent event=(ActivitiEntityEvent)listener.getEventsReceived().get(0);
  assertEquals(ActivitiEventType.ENTITY_CREATED,event.getType());
  assertEquals(processInstance.getId(),((ProcessInstance)event.getEntity()).getId());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(1);
  assertEquals(ActivitiEventType.ENTITY_INITIALIZED,event.getType());
  assertEquals(processInstance.getId(),((ProcessInstance)event.getEntity()).getId());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(2);
  assertEquals(ActivitiEventType.PROCESS_STARTED,event.getType());
  assertEquals(processInstance.getId(),((ProcessInstance)event.getEntity()).getId());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  assertTrue(event instanceof ActivitiProcessStartedEvent);
  assertNull(((ActivitiProcessStartedEvent)event).getNestedProcessDefinitionId());
  assertNull(((ActivitiProcessStartedEvent)event).getNestedProcessInstanceId());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(3);
  assertEquals(ActivitiEventType.ENTITY_CREATED,event.getType());
  assertEquals(processInstance.getId(),((ProcessInstance)event.getEntity()).getParentId());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(4);
  assertEquals(ActivitiEventType.ENTITY_INITIALIZED,event.getType());
  assertEquals(processInstance.getId(),((ProcessInstance)event.getEntity()).getParentId());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(5);
  assertEquals(ActivitiEventType.ENTITY_CREATED,event.getType());
  assertEquals("simpleSubProcess",((ExecutionEntity)event.getEntity()).getProcessDefinition().getKey());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(6);
  assertEquals(ActivitiEventType.ENTITY_INITIALIZED,event.getType());
  assertEquals("simpleSubProcess",((ExecutionEntity)event.getEntity()).getProcessDefinition().getKey());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(7);
  assertEquals(ActivitiEventType.PROCESS_STARTED,event.getType());
  assertEquals("simpleSubProcess",((ExecutionEntity)event.getEntity()).getProcessDefinition().getKey());
  assertTrue(event instanceof ActivitiProcessStartedEvent);
  assertEquals(processInstance.getProcessDefinitionId(),((ActivitiProcessStartedEvent)event).getNestedProcessDefinitionId());
  assertEquals(processInstance.getId(),((ActivitiProcessStartedEvent)event).getNestedProcessInstanceId());
  listener.clearEventsReceived();
}
