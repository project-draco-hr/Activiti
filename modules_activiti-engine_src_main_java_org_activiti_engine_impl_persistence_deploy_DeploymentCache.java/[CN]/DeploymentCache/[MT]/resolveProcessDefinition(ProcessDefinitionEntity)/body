{
  String processDefinitionId=processDefinition.getId();
  String deploymentId=processDefinition.getDeploymentId();
  processDefinition=processDefinitionCache.get(processDefinitionId);
  if (processDefinition == null) {
    DeploymentEntity deployment=Context.getCommandContext().getDeploymentManager().findDeploymentById(deploymentId);
    deployment.setNew(false);
    deploy(deployment);
    processDefinition=processDefinitionCache.get(processDefinitionId);
    if (processDefinition == null) {
      throw new ActivitiException("deploying " + deploymentId + " didn't put process definition "+ processDefinitionId+ " in the cache");
    }
  }
  return processDefinition;
}
