{
  if (authenticate() == false)   return null;
  String userId=(String)getRequest().getAttributes().get("userId");
  if (userId == null) {
    throw new ActivitiIllegalArgumentException("No userId provided");
  }
  if (groupIds == null) {
    throw new ActivitiIllegalArgumentException("No groupIds provided");
  }
  IdentityService identityService=ActivitiUtil.getIdentityService();
  if (identityService.createUserQuery().userId(userId).singleResult() == null)   throw new ActivitiObjectNotFoundException("The user '" + userId + " does not exist.",User.class);
  for (  String groupId : groupIds) {
    if (identityService.createGroupQuery().groupId(groupId).singleResult() == null)     throw new ActivitiObjectNotFoundException("Group '" + groupId + "' does not exist.",Group.class);
  }
  for (  String groupId : groupIds) {
    if (identityService.createUserQuery().userId(userId).memberOfGroup(groupId).singleResult() == null)     identityService.createMembership(userId,groupId);
  }
  return new LegacyStateResponse().setSuccess(true);
}
