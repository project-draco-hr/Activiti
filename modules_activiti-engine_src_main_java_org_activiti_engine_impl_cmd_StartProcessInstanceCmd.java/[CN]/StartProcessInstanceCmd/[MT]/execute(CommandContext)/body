{
  RepositorySession repositorySession=commandContext.getRepositorySession();
  ProcessDefinitionEntity processDefinition=null;
  if (processDefinitionId != null) {
    processDefinition=repositorySession.findDeployedProcessDefinitionById(processDefinitionId);
    if (processDefinition == null) {
      throw new ActivitiException("No process definition found for id = '" + processDefinitionId + "'");
    }
  }
 else   if (processDefinitionKey != null) {
    processDefinition=repositorySession.findDeployedLatestProcessDefinitionByKey(processDefinitionKey);
    if (processDefinition == null) {
      throw new ActivitiException("No process definition found for key '" + processDefinitionKey + "'");
    }
  }
 else {
    throw new ActivitiException("processDefinitionKey and processDefinitionId are null");
  }
  ExecutionEntity processInstance=processDefinition.createProcessInstance();
  if (variables != null) {
    try {
      VariableMap.setExternalUpdate(Boolean.TRUE);
      processInstance.setVariables(variables);
    }
  finally {
      VariableMap.setExternalUpdate(null);
    }
  }
  if (businessKey != null) {
    processInstance.setBusinessKey(businessKey);
  }
  processInstance.start();
  return processInstance;
}
