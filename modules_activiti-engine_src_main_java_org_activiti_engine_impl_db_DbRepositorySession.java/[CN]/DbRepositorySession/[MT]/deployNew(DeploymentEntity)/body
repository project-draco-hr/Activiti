{
  dbSqlSession.insert(deployment);
  for (  ResourceEntity resource : deployment.getResources().values()) {
    resource.setDeploymentId(deployment.getId());
    dbSqlSession.insert(resource);
  }
  for (  Deployer deployer : dbRepositorySessionFactory.getDeployers()) {
    List<ProcessDefinitionEntity> processDefinitions=deployer.deploy(deployment);
    for (    ProcessDefinitionEntity processDefinition : processDefinitions) {
      int processDefinitionVersion;
      ProcessDefinitionEntity latestProcessDefinition=findLatestProcessDefinitionByKey(processDefinition.getKey());
      if (latestProcessDefinition != null) {
        processDefinitionVersion=latestProcessDefinition.getVersion() + 1;
      }
 else {
        processDefinitionVersion=1;
      }
      processDefinition.setVersion(processDefinitionVersion);
      processDefinition.setDeploymentId(deployment.getId());
      String processDefinitionId=processDefinition.getKey() + ":" + processDefinition.getVersion();
      if (processDefinitionId.length() > 64) {
        throw new ActivitiException("Invalid process definition id: '" + processDefinitionId + "': id can be maximum 64 characters");
      }
      processDefinition.setId(processDefinitionId);
      dbSqlSession.insert(processDefinition);
      addToProcessDefinitionCache(processDefinition);
    }
  }
}
