{
  ActivityInstanceImpl activityInstance=executionContext.activityInstance;
  activityInstance.setEnded(true);
  ScopeInstanceImpl parent=activityInstance.getParent();
  activityInstance.destroy();
  parent.removeActivityInstance(activityInstance);
  executionContext.scopeInstance=parent;
  if (parent instanceof ProcessInstanceImpl) {
    if (parent.getActivityInstances().isEmpty()) {
      executionContext.activityInstance=null;
      executionContext.fireEvent(parent.getScope(),Event.PROCESS_END,PROCESS_END);
    }
  }
 else {
    executionContext.activityInstance=(ActivityInstanceImpl)parent;
    ActivityImpl activity=activityInstance.getActivity();
    ActivityBehavior activityBehavior=activity.getActivityBehavior();
    if (activityBehavior instanceof CompositeActivityBehavior) {
      try {
        ((CompositeActivityBehavior)activityBehavior).activityInstanceEnded(executionContext);
      }
 catch (      RuntimeException e) {
        log.log(Level.SEVERE,getDelegationExceptionMessage(activity,"activityInstanceEnded",e),e);
        throw e;
      }
catch (      Exception e) {
        String delegationExceptionMessage=getDelegationExceptionMessage(activity,"activityInstanceEnded",e);
        log.log(Level.SEVERE,delegationExceptionMessage,e);
        throw new PvmException(delegationExceptionMessage,e);
      }
    }
  }
}
