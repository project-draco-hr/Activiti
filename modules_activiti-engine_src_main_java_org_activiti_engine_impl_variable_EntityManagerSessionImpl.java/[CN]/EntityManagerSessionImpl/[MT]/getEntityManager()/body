{
  if (entityManager == null) {
    entityManager=getEntityManagerFactory().createEntityManager();
    if (handleTransactions) {
      CommandContext.getCurrent().getTransactionContext().addTransactionListener(TransactionState.COMMITTED,new TransactionListener(){
        public void execute(        CommandContext commandContext){
          if (isTransactionActive()) {
            entityManager.getTransaction().commit();
          }
        }
      }
);
      CommandContext.getCurrent().getTransactionContext().addTransactionListener(TransactionState.ROLLED_BACK,new TransactionListener(){
        public void execute(        CommandContext commandContext){
          if (isTransactionActive()) {
            entityManager.getTransaction().rollback();
          }
        }
      }
);
      if (!isTransactionActive()) {
        entityManager.getTransaction().begin();
      }
    }
  }
  return entityManager;
}
