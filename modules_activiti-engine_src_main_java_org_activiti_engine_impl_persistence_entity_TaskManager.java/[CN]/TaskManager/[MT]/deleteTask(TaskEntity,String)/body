{
  if (!task.isDeleted()) {
    task.setDeleted(true);
    String taskId=task.getId();
    IdentityLinkManager identityLinkManager=Context.getCommandContext().getIdentityLinkManager();
    List<IdentityLinkEntity> identityLinks=identityLinkManager.findIdentityLinksByTaskId(taskId);
    for (    IdentityLinkEntity identityLink : identityLinks) {
      identityLinkManager.deleteIdentityLink(identityLink);
    }
    VariableInstanceManager variableInstanceManager=Context.getCommandContext().getVariableInstanceManager();
    List<VariableInstanceEntity> variableInstances=variableInstanceManager.findVariableInstancesByTaskId(taskId);
    for (    VariableInstanceEntity variableInstance : variableInstances) {
      variableInstanceManager.deleteVariableInstance(variableInstance);
    }
    CommandContext commandContext=Context.getCommandContext();
    DbSqlSession dbSqlSession=commandContext.getDbSqlSession();
    int historyLevel=Context.getProcessEngineConfiguration().getHistoryLevel();
    if (historyLevel >= ProcessEngineConfigurationImpl.HISTORYLEVEL_AUDIT) {
      HistoricTaskInstanceEntity historicTaskInstance=dbSqlSession.selectById(HistoricTaskInstanceEntity.class,task.getId());
      if (historicTaskInstance != null) {
        historicTaskInstance.markEnded(deleteReason);
      }
    }
    getPersistenceSession().delete(TaskEntity.class,task.getId());
  }
}
