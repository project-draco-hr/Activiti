{
  DeploymentEntity deployment=deploymentBuilder.getDeployment();
  deployment.setDeploymentTime(ClockUtil.getCurrentTime());
  if (deploymentBuilder.isDuplicateFilterEnabled()) {
    DeploymentEntity existingDeployment=Context.getCommandContext().getDeploymentEntityManager().findLatestDeploymentByName(deployment.getName());
    if ((existingDeployment != null) && !deploymentsDiffer(deployment,existingDeployment)) {
      return existingDeployment;
    }
  }
  deployment.setNew(true);
  Context.getCommandContext().getDeploymentEntityManager().insertDeployment(deployment);
  if (Context.getProcessEngineConfiguration().getEventDispatcher().isEnabled()) {
    Context.getProcessEngineConfiguration().getEventDispatcher().dispatchEvent(ActivitiEventBuilder.createEntityEvent(ActivitiEventType.ENTITY_CREATED,deployment));
  }
  Map<String,Object> deploymentSettings=new HashMap<String,Object>();
  deploymentSettings.put(DeploymentSettings.IS_BPMN20_XSD_VALIDATION_ENABLED,deploymentBuilder.isBpmn20XsdValidationEnabled());
  deploymentSettings.put(DeploymentSettings.IS_PROCESS_VALIDATION_ENABLED,deploymentBuilder.isProcessValidationEnabled());
  Context.getProcessEngineConfiguration().getDeploymentManager().deploy(deployment,deploymentSettings);
  if (deploymentBuilder.getProcessDefinitionsActivationDate() != null) {
    scheduleProcessDefinitionActivation(commandContext,deployment);
  }
  if (Context.getProcessEngineConfiguration().getEventDispatcher().isEnabled()) {
    Context.getProcessEngineConfiguration().getEventDispatcher().dispatchEvent(ActivitiEventBuilder.createEntityEvent(ActivitiEventType.ENTITY_INITIALIZED,deployment));
  }
  return deployment;
}
