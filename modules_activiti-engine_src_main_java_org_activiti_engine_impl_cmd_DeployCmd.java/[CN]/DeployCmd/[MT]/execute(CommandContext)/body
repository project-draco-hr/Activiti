{
  DeploymentEntity deployment=deploymentBuilder.getDeployment();
  RepositorySession repositorySession=commandContext.getRepositorySession();
  deployment.setDeploymentTime(ClockUtil.getCurrentTime());
  if (deploymentBuilder.isDuplicateFilterEnabled()) {
    DeploymentEntity existingDeployment=repositorySession.findLatestDeploymentByName(deployment.getName());
    if ((existingDeployment != null) && !deploymentsDiffer(deployment,existingDeployment)) {
      return existingDeployment;
    }
  }
  deployment.setNew(true);
  repositorySession.deploy(deployment);
  return deployment;
}
