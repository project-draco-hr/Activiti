{
  ActivityImpl activity=execution.getActivity();
  ScopeImpl scope=null;
  if (activity != null) {
    scope=activity;
  }
 else {
    scope=execution.getProcessDefinition();
  }
  List<EventListener> eventListeners=scope.getEventListeners(EventListener.EVENTNAME_END);
  int eventListenerIndex=execution.getEventListenerIndex();
  if (eventListeners.size() > eventListenerIndex) {
    execution.setEventName(EventListener.EVENTNAME_END);
    execution.setEventSource(scope);
    EventListener listener=eventListeners.get(eventListenerIndex);
    listener.notify(execution);
    execution.setEventListenerIndex(eventListenerIndex + 1);
    execution.performOperation(this);
  }
 else {
    execution.setEventListenerIndex(0);
    execution.setEventName(null);
    execution.setEventSource(null);
    if ((execution.isScope()) && (activity != null) && (!activity.isScope())) {
      execution.setActivity(activity.getParentActivity());
      execution.performOperation(AtomicOperation.DELETE_CASCADE_FIRE_ACTIVITY_END);
    }
 else {
      ExecutionImpl parent=execution.getParent();
      if (execution.isScope()) {
        execution.destroyScope();
      }
      execution.remove();
      if (parent != null) {
        parent.performOperation(AtomicOperation.DELETE_CASCADE);
      }
    }
  }
}
