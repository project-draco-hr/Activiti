{
  CommandContext commandContext=Context.getCommandContext();
  List<EventSubscriptionDeclaration> messageEventDefinitions=(List<EventSubscriptionDeclaration>)processDefinition.getProperty(BpmnParse.PROPERTYNAME_EVENT_SUBSCRIPTION_DECLARATION);
  if (messageEventDefinitions != null) {
    for (    EventSubscriptionDeclaration messageEventDefinition : messageEventDefinitions) {
      if (messageEventDefinition.isStartEvent()) {
        List<EventSubscriptionEntity> subscriptionsForSameMessageName=commandContext.getEventSubscriptionManager().findEventSubscriptionsByName(MessageEventHandler.EVENT_HANDLER_TYPE,messageEventDefinition.getEventName());
        List<MessageEventSubscriptionEntity> cachedSubscriptions=commandContext.getDbSqlSession().findInCache(MessageEventSubscriptionEntity.class);
        for (        MessageEventSubscriptionEntity cachedSubscription : cachedSubscriptions) {
          if (messageEventDefinition.getEventName().equals(cachedSubscription.getEventName()) && !subscriptionsForSameMessageName.contains(cachedSubscription)) {
            subscriptionsForSameMessageName.add(cachedSubscription);
          }
        }
        subscriptionsForSameMessageName=commandContext.getDbSqlSession().pruneDeletedEntities(subscriptionsForSameMessageName);
        if (!subscriptionsForSameMessageName.isEmpty()) {
          throw new ActivitiException("Cannot deploy process definition '" + processDefinition.getResourceName() + "': there already is a message event subscription for the message with name '"+ messageEventDefinition.getEventName()+ "'.");
        }
        MessageEventSubscriptionEntity newSubscription=new MessageEventSubscriptionEntity();
        newSubscription.setEventName(messageEventDefinition.getEventName());
        newSubscription.setActivityId(messageEventDefinition.getActivityId());
        newSubscription.setConfiguration(processDefinition.getId());
        newSubscription.insert();
      }
    }
  }
}
