{
  CommandContext commandContext=CommandContext.getCurrent();
  IdGenerator idGenerator=commandContext.getProcessEngineConfiguration().getIdGenerator();
  ExecutionEntity executionEntity=(ExecutionEntity)execution;
  String processDefinitionId=executionEntity.getProcessDefinitionId();
  String processInstanceId=executionEntity.getProcessInstanceId();
  String executionId=execution.getId();
  HistoricActivityInstanceEntity historicActivityInstance=new HistoricActivityInstanceEntity();
  historicActivityInstance.setId(Long.toString(idGenerator.getNextId()));
  historicActivityInstance.setProcessDefinitionId(processDefinitionId);
  historicActivityInstance.setProcessInstanceId(processInstanceId);
  historicActivityInstance.setExecutionId(executionId);
  historicActivityInstance.setActivityId(executionEntity.getActivityId());
  historicActivityInstance.setActivityName((String)executionEntity.getActivity().getProperty("name"));
  historicActivityInstance.setActivityType((String)executionEntity.getActivity().getProperty("type"));
  Date now=ClockUtil.getCurrentTime();
  historicActivityInstance.setStartTime(now);
  historicActivityInstance.setEndTime(now);
  historicActivityInstance.setDurationInMillis(0L);
  commandContext.getDbSqlSession().insert(historicActivityInstance);
}
