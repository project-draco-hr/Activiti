{
  ProcessInstanceResponse result=new ProcessInstanceResponse();
  result.setActivityId(processInstance.getActivityId());
  result.setBusinessKey(processInstance.getBusinessKey());
  result.setId(processInstance.getId());
  result.setProcessDefinitionId(processInstance.getProcessDefinitionId());
  result.setProcessDefinitionUrl(securedResource.createFullResourceUrl(RestUrls.URL_PROCESS_DEFINITION,processInstance.getProcessDefinitionId()));
  result.setEnded(processInstance.isEnded());
  result.setSuspended(processInstance.isSuspended());
  result.setUrl(securedResource.createFullResourceUrl(RestUrls.URL_PROCESS_INSTANCE,processInstance.getId()));
  result.setTenantId(processInstance.getTenantId());
  if (processInstance.isEnded()) {
    result.setCompleted(true);
  }
 else {
    result.setCompleted(false);
  }
  if (returnVariables) {
    RuntimeService runtimeService=ActivitiUtil.getRuntimeService();
    HistoryService historyService=ActivitiUtil.getHistoryService();
    if (processInstance.isEnded()) {
      Map<String,Object> variableMap=new HashMap<String,Object>();
      List<HistoricDetail> historicDetailList=historyService.createHistoricDetailQuery().executionId(processInstance.getId()).list();
      for (      HistoricDetail historicDetail : historicDetailList) {
        Map<String,Integer> versionMap=new HashMap<String,Integer>();
        if (historicDetail instanceof HistoricVariableUpdate) {
          HistoricVariableUpdate historicVariableUpdate=(HistoricVariableUpdate)historicDetail;
          if (versionMap.get(historicVariableUpdate.getVariableName()) == null) {
            versionMap.put(historicVariableUpdate.getVariableName(),historicVariableUpdate.getRevision());
            variableMap.put(historicVariableUpdate.getVariableName(),historicVariableUpdate.getValue());
          }
 else {
            Integer currentRevision=historicVariableUpdate.getRevision();
            Integer previousRevision=versionMap.get(historicVariableUpdate.getVariableName());
            if (currentRevision > previousRevision) {
              versionMap.put(historicVariableUpdate.getVariableName(),currentRevision);
              variableMap.put(historicVariableUpdate.getVariableName(),historicVariableUpdate.getValue());
            }
          }
        }
      }
      for (      String name : variableMap.keySet()) {
        result.addVariable(createRestVariable(securedResource,name,variableMap.get(name),RestVariableScope.LOCAL,processInstance.getId(),VARIABLE_PROCESS,false));
      }
    }
 else {
      Map<String,Object> variableMap=runtimeService.getVariables(processInstance.getId());
      for (      String name : variableMap.keySet()) {
        result.addVariable(createRestVariable(securedResource,name,variableMap.get(name),RestVariableScope.LOCAL,processInstance.getId(),VARIABLE_PROCESS,false));
      }
    }
  }
  return result;
}
