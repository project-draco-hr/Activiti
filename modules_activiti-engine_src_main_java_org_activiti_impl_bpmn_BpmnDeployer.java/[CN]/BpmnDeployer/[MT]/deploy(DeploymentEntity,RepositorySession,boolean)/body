{
  Map<String,ResourceEntity> resources=deployment.getResources();
  for (  String resourceName : resources.keySet()) {
    LOG.info("Processing resource " + resourceName);
    if (resourceName.endsWith(BPMN_RESOURCE_SUFFIX)) {
      ResourceEntity resource=resources.get(resourceName);
      byte[] bytes=resource.getBytes();
      ByteArrayInputStream inputStream=new ByteArrayInputStream(bytes);
      BpmnParse bpmnParse=new BpmnParser(expressionManager,scriptingEngines,businessCalendarManager).createParse().processDefinitionClass(ProcessDefinitionEntity.class).sourceInputStream(inputStream).execute();
      for (      ProcessDefinitionEntity processDefinition : bpmnParse.getProcessDefinitions()) {
        processDefinition.setDeployment(deployment);
        if (isNew) {
          repositorySession.insertProcessDefinition(processDefinition);
        }
 else {
          String deploymentId=processDefinition.getDeployment().getId();
          ProcessDefinitionEntity persistedProcessDefinition=repositorySession.findProcessDefinitionByDeploymentAndKey(deploymentId,processDefinition.getKey());
          processDefinition.setId(persistedProcessDefinition.getId());
          processDefinition.setVersion(persistedProcessDefinition.getVersion());
        }
      }
    }
  }
}
