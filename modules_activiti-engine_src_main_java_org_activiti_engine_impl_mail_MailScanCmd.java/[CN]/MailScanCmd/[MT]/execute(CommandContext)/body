{
  log.fine("scanning mail for user " + userId);
  Store store=null;
  Folder toDoFolder=null;
  Folder toDoInActiviti=null;
  try {
    Session session=Session.getDefaultInstance(new Properties());
    store=session.getStore(imapProtocol);
    log.fine("connecting to " + imapHost + " over "+ imapProtocol+ " for user "+ imapUsername);
    store.connect(imapHost,imapUsername,imapPassword);
    toDoFolder=store.getFolder(toDoFolderName);
    toDoFolder.open(Folder.READ_WRITE);
    toDoInActiviti=store.getFolder(toDoInActivitiFolderName);
    toDoInActiviti.open(Folder.READ_WRITE);
    Message[] messages=toDoFolder.getMessages();
    log.fine("getting messages from myToDoFolder");
    DbSqlSession dbSqlSession=commandContext.getDbSqlSession();
    TaskEntity task=new TaskEntity();
    task.setAssignee(imapUsername);
    for (    Message message : messages) {
      log.fine("transforming mail into activiti task: " + message.getSubject());
      MailTransformer messageTransformer=new MailTransformer(message);
      List<AttachmentEntity> attachments=messageTransformer.getAttachments();
      for (      AttachmentEntity attachment : attachments) {
        ByteArrayEntity content=attachment.getContent();
        dbSqlSession.insert(content);
        attachment.setContentId(content.getId());
        dbSqlSession.insert(attachment);
      }
    }
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
    throw new ActivitiException("couldn't scan mail for user " + userId + ": "+ e.getMessage(),e);
  }
 finally {
    if (toDoInActiviti != null) {
      try {
        toDoInActiviti.close(false);
      }
 catch (      MessagingException e) {
        e.printStackTrace();
      }
    }
    if (toDoFolder != null) {
      try {
        toDoFolder.close(true);
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
    if (store != null) {
      try {
        store.close();
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
  }
  return null;
}
