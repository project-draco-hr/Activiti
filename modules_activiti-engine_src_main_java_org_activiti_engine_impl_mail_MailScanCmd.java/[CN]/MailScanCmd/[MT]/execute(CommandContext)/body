{
  log.fine("scanning mail for user " + userId);
  Store store=null;
  Folder toDoFolder=null;
  Folder toDoInActivitiFolder=null;
  try {
    Session session=Session.getDefaultInstance(new Properties());
    store=session.getStore(imapProtocol);
    log.fine("connecting to " + imapHost + " over "+ imapProtocol+ " for user "+ imapUsername);
    store.connect(imapHost,imapUsername,imapPassword);
    toDoFolder=store.getFolder(toDoFolderName);
    toDoFolder.open(Folder.READ_WRITE);
    toDoInActivitiFolder=store.getFolder(toDoInActivitiFolderName);
    toDoInActivitiFolder.open(Folder.READ_WRITE);
    Message[] messages=toDoFolder.getMessages();
    log.fine("getting messages from myToDoFolder");
    DbSqlSession dbSqlSession=commandContext.getDbSqlSession();
    for (    Message message : messages) {
      log.fine("transforming mail into activiti task: " + message.getSubject());
      MailTransformer mailTransformer=new MailTransformer(message);
      createTask(commandContext,dbSqlSession,mailTransformer);
      Message[] messagesToCopy=new Message[]{message};
      toDoFolder.copyMessages(messagesToCopy,toDoInActivitiFolder);
      message.setFlag(Flags.Flag.DELETED,true);
    }
  }
 catch (  RuntimeException e) {
    throw e;
  }
catch (  Exception e) {
    throw new ActivitiException("couldn't scan mail for user " + userId + ": "+ e.getMessage(),e);
  }
 finally {
    if (toDoInActivitiFolder != null && toDoInActivitiFolder.isOpen()) {
      try {
        toDoInActivitiFolder.close(false);
      }
 catch (      MessagingException e) {
        e.printStackTrace();
      }
    }
    if (toDoFolder != null && toDoFolder.isOpen()) {
      try {
        toDoFolder.close(true);
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
    if (store != null) {
      try {
        store.close();
      }
 catch (      Exception e) {
        e.printStackTrace();
      }
    }
  }
  return null;
}
