{
  String taskDescription=mailTransformer.getHtml();
  taskDescription=taskDescription.replaceAll("\\<.*?\\>","");
  taskDescription=taskDescription.replaceAll("\\s"," ");
  taskDescription=taskDescription.trim();
  if (taskDescription.length() > 120) {
    taskDescription=taskDescription.substring(0,117) + "...";
  }
  TaskEntity task=new TaskEntity();
  task.setAssignee(userId);
  task.setName(mailTransformer.getMessage().getSubject());
  task.setDescription(taskDescription);
  dbSqlSession.insert(task);
  String taskId=task.getId();
  for (  String recipientEmailAddress : mailTransformer.getRecipients()) {
    User recipient=new UserQueryImpl(commandContext).userEmail(recipientEmailAddress).singleResult();
    if (recipient != null) {
      task.addUserIdentityLink(recipient.getId(),"Recipient");
    }
  }
  List<AttachmentEntity> attachments=mailTransformer.getAttachments();
  for (  AttachmentEntity attachment : attachments) {
    ByteArrayEntity content=attachment.getContent();
    dbSqlSession.insert(content);
    attachment.setContentId(content.getId());
    attachment.setTaskId(taskId);
    dbSqlSession.insert(attachment);
  }
}
