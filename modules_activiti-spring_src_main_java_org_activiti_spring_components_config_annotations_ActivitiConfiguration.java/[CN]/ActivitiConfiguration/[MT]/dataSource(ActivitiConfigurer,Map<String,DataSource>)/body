{
  DataSource ds=null;
  if (activitiConfigurer != null) {
    DataSource dataSource=activitiConfigurer.dataSource();
    if (null != dataSource) {
      ds=dataSource;
    }
  }
  if (dataSourceMap != null) {
    if (!dataSourceMap.isEmpty()) {
      for (      DataSource d : dataSourceMap.values()) {
        ds=d;
      }
    }
    String defaultName="activitiDataSource";
    if (dataSourceMap.containsKey(defaultName)) {
      ds=dataSourceMap.get(defaultName);
    }
  }
  if (ds == null) {
    try {
      SimpleDriverDataSource simpleDriverDataSource=new SimpleDriverDataSource();
      simpleDriverDataSource.setDriverClass((Class<? extends Driver>)Class.forName("org.h2.Driver"));
      simpleDriverDataSource.setUrl("jdbc:h2:mem:activiti;DB_CLOSE_DELAY=1000");
      simpleDriverDataSource.setUsername("sa");
      simpleDriverDataSource.setPassword("");
      ds=simpleDriverDataSource;
    }
 catch (    ClassNotFoundException e) {
      throw new ActivitiException("No dataSource bean was found. Tried to create default H2 in memory database, " + "but couldn't find the driver on the classpath");
    }
  }
  return ds;
}
