{
  SuspensionStateUtil.setSuspensionState(processDefinitionEntity,getProcessDefinitionSuspensionState());
  Context.getProcessEngineConfiguration().getDeploymentCache().removeProcessDefinition(processDefinitionEntity.getId());
  if (includeProcessInstances) {
    int currentStartIndex=0;
    List<ProcessInstance> processInstances=fetchProcessInstancesPage(commandContext,processDefinitionEntity,currentStartIndex);
    while (processInstances.size() > 0) {
      for (      ProcessInstance processInstance : processInstances) {
        AbstractSetProcessInstanceStateCmd processInstanceCmd=getProcessInstanceChangeStateCmd(processInstance);
        processInstanceCmd.execute(commandContext);
      }
      currentStartIndex+=processInstances.size();
      processInstances=fetchProcessInstancesPage(commandContext,processDefinitionEntity,currentStartIndex);
    }
  }
}
