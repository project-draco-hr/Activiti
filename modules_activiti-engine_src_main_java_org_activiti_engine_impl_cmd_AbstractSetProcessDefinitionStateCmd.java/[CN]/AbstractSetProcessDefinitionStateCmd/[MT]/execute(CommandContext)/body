{
  if (processDefinitionId == null && processDefinitionKey == null) {
    throw new ActivitiException("Process definition id / key cannot be null");
  }
  ProcessDefinitionEntity processDefinitionEntity=null;
  ProcessDefinitionManager processDefinitionManager=commandContext.getProcessDefinitionManager();
  if (processDefinitionId == null) {
    processDefinitionEntity=processDefinitionManager.findLatestProcessDefinitionByKey(processDefinitionKey);
    if (processDefinitionEntity == null) {
      throw new ActivitiException("Cannot find process definition for key '" + processDefinitionKey + "'");
    }
  }
 else {
    processDefinitionEntity=processDefinitionManager.findLatestProcessDefinitionById(processDefinitionId);
    if (processDefinitionEntity == null) {
      throw new ActivitiException("Cannot find process definition for id '" + processDefinitionId + "'");
    }
  }
  setState(processDefinitionEntity);
  Context.getProcessEngineConfiguration().getDeploymentCache().removeProcessDefinition(processDefinitionEntity.getId());
  if (includeProcessInstances) {
    int currentStartIndex=0;
    List<ProcessInstance> processInstances=fetchProcessInstancesPage(commandContext,processDefinitionEntity,currentStartIndex);
    while (processInstances.size() > 0) {
      for (      ProcessInstance processInstance : processInstances) {
        AbstractSetProcessInstanceStateCmd processInstanceCmd=getProcessInstanceCmd(processInstance);
        processInstanceCmd.execute(commandContext);
      }
      currentStartIndex+=processInstances.size();
      processInstances=fetchProcessInstancesPage(commandContext,processDefinitionEntity,currentStartIndex);
    }
  }
  return null;
}
