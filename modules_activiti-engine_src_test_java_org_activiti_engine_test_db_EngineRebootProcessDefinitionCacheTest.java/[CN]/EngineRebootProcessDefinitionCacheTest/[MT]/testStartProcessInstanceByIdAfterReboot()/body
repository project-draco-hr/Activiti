{
  ProcessEngineTestCase.closeProcessEngines();
  ProcessEngineConfiguration processEngineConfiguration=new ProcessEngineConfiguration();
  processEngineConfiguration.setJdbcUrl("jdbc:h2:mem:activiti-reboot-test;DB_CLOSE_DELAY=1000");
  processEngineConfiguration.dbSchemaCreate();
  ProcessEngine processEngine=new ProcessEngineBuilder().setDbSchemaStrategy(DbSchemaStrategy.CHECK_VERSION).setJdbcUrl("jdbc:h2:mem:activiti-reboot-test;DB_CLOSE_DELAY=1000").setJobExecutorAutoActivation(false).buildProcessEngine();
  processEngine.getRepositoryService().createDeployment().addClasspathResource("org/activiti/engine/test/db/EngineRebootProcessDefinitionCacheTest.bpmn20.xml").deploy();
  List<ProcessDefinition> processDefinitions=processEngine.getRepositoryService().findProcessDefinitions();
  assertEquals(1,processDefinitions.size());
  ProcessInstance processInstance=processEngine.getProcessService().startProcessInstanceById(processDefinitions.get(0).getId());
  String processInstanceId=processInstance.getId();
  assertNotNull(processInstance);
  processEngine.close();
  assertNotNull(processEngine.getProcessService());
  processEngine=new ProcessEngineBuilder().setDbSchemaStrategy(DbSchemaStrategy.CHECK_VERSION).setJdbcUrl("jdbc:h2:mem:activiti-reboot-test;DB_CLOSE_DELAY=1000").setJobExecutorAutoActivation(false).buildProcessEngine();
  processInstance=processEngine.getProcessService().findProcessInstanceById(processInstanceId);
  assertNotNull(processInstance);
  TaskService taskService=processEngine.getTaskService();
  Task task=taskService.createTaskQuery().list().get(0);
  taskService.complete(task.getId());
  processInstance=processEngine.getProcessService().findProcessInstanceById(processInstanceId);
  assertNull(processInstance);
  processInstance=processEngine.getProcessService().startProcessInstanceById(processDefinitions.get(0).getId());
  assertNotNull(processInstance);
  processEngine.close();
  processEngineConfiguration.dbSchemaDrop();
}
