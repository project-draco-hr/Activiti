{
  Calendar calendar=Calendar.getInstance();
  Date baseTime=calendar.getTime();
  calendar.add(Calendar.MINUTE,20);
  DateTimeFormatter fmt=ISODateTimeFormat.dateTime();
  DateTime dt=new DateTime(calendar.getTime());
  String dateStr=fmt.print(dt);
  calendar.setTime(baseTime);
  calendar.add(Calendar.HOUR,2);
  dt=new DateTime(calendar.getTime());
  String dateStr1=fmt.print(dt);
  calendar.setTime(baseTime);
  calendar.add(Calendar.HOUR,1);
  calendar.add(Calendar.MINUTE,30);
  dt=new DateTime(calendar.getTime());
  String dateStr2=fmt.print(dt);
  Calendar nextTimeCal=Calendar.getInstance();
  nextTimeCal.setTime(baseTime);
  processEngineConfiguration.getClock().setCurrentTime(nextTimeCal.getTime());
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("repeatWithEnd");
  runtimeService.setVariable(processInstance.getId(),"EndDateForBoundary",dateStr);
  runtimeService.setVariable(processInstance.getId(),"EndDateForCatch1",dateStr1);
  runtimeService.setVariable(processInstance.getId(),"EndDateForCatch2",dateStr2);
  List<Task> tasks=taskService.createTaskQuery().list();
  assertEquals(1,tasks.size());
  Task task=tasks.get(0);
  assertEquals("Task A",task.getName());
  taskService.complete(task.getId());
  List<Job> jobs=managementService.createJobQuery().list();
  assertEquals(1,jobs.size());
  managementService.executeJob(jobs.get(0).getId());
  jobs=managementService.createJobQuery().list();
  assertEquals(1,jobs.size());
  nextTimeCal.add(Calendar.MINUTE,15);
  processEngineConfiguration.getClock().setCurrentTime(nextTimeCal.getTime());
  managementService.executeJob(jobs.get(0).getId());
  jobs=managementService.createJobQuery().list();
  assertEquals(1,jobs.size());
  nextTimeCal.add(Calendar.MINUTE,5);
  nextTimeCal.add(Calendar.SECOND,1);
  processEngineConfiguration.getClock().setCurrentTime(nextTimeCal.getTime());
  managementService.executeJob(jobs.get(0).getId());
  jobs=managementService.createJobQuery().list();
  assertEquals(0,jobs.size());
  tasks=taskService.createTaskQuery().list();
  assertEquals(1,tasks.size());
  task=tasks.get(0);
  assertEquals("Task B",task.getName());
  taskService.complete(task.getId());
  try {
    waitForJobExecutorToProcessAllJobs(2000,500);
    fail("Expected that job isn't executed because the timer is in t0");
  }
 catch (  Exception e) {
  }
  nextTimeCal.add(Calendar.HOUR,1);
  processEngineConfiguration.getClock().setCurrentTime(nextTimeCal.getTime());
  waitForJobExecutorToProcessAllJobs(2000,500);
  jobs=managementService.createJobQuery().list();
  assertEquals(0,jobs.size());
  tasks=taskService.createTaskQuery().list();
  assertEquals(1,tasks.size());
  task=tasks.get(0);
  assertEquals("Task C",task.getName());
  taskService.complete(task.getId());
  nextTimeCal.add(Calendar.MINUTE,10);
  processEngineConfiguration.getClock().setCurrentTime(nextTimeCal.getTime());
  waitForJobExecutorToProcessAllJobs(2000,500);
  HistoricProcessInstance historicInstance=historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).singleResult();
  assertNotNull(historicInstance.getEndTime());
}
