{
  Document document=XmlToTextTransformation.buildDocument(new ByteArrayInputStream(bpmnXml.getBytes()));
  NodeList bpmnShapes=document.getElementsByTagName("bpmndi:BPMNShape");
  NodeList process=document.getElementsByTagName("process");
  Element processEl=(Element)process.item(0);
  List<Element> elementsToRemove=new ArrayList<Element>();
  for (int i=0; i < bpmnShapes.getLength(); i++) {
    Element currentShape=(Element)bpmnShapes.item(i);
    String referencedElementId=currentShape.getAttribute("bpmnElement");
    Node referencedElement=getElementById(referencedElementId,processEl);
    if (referencedElement == null) {
      elementsToRemove.add(currentShape);
    }
  }
  for (  Element element : elementsToRemove) {
    element.getParentNode().removeChild(element);
  }
  return XmlToTextTransformation.getXmlAsString(new DOMSource(document));
}
