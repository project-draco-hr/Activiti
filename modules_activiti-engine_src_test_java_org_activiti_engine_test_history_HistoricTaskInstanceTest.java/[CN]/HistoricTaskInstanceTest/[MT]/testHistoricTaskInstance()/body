{
  String processInstanceId=runtimeService.startProcessInstanceByKey("HistoricTaskInstanceTest").getId();
  Task runtimeTask=taskService.createTaskQuery().processInstanceId(processInstanceId).singleResult();
  runtimeTask.setPriority(1234);
  Calendar dueDateCal=Calendar.getInstance();
  runtimeTask.setDueDate(dueDateCal.getTime());
  taskService.saveTask(runtimeTask);
  String taskId=runtimeTask.getId();
  String taskDefinitionKey=runtimeTask.getTaskDefinitionKey();
  HistoricTaskInstance historicTaskInstance=historyService.createHistoricTaskInstanceQuery().singleResult();
  assertEquals(taskId,historicTaskInstance.getId());
  assertEquals(1234,historicTaskInstance.getPriority());
  assertEquals("Clean up",historicTaskInstance.getName());
  assertEquals("Schedule an engineering meeting for next week with the new hire.",historicTaskInstance.getDescription());
  assertEquals(dueDateCal.getTime(),historicTaskInstance.getDueDate());
  assertEquals("kermit",historicTaskInstance.getAssignee());
  assertEquals(taskDefinitionKey,historicTaskInstance.getTaskDefinitionKey());
  assertNull(historicTaskInstance.getEndTime());
  assertNull(historicTaskInstance.getDurationInMillis());
  runtimeService.setVariable(processInstanceId,"deadline","yesterday");
  taskService.complete(taskId);
  assertEquals(1,historyService.createHistoricTaskInstanceQuery().count());
  historicTaskInstance=historyService.createHistoricTaskInstanceQuery().singleResult();
  assertEquals(taskId,historicTaskInstance.getId());
  assertEquals(1234,historicTaskInstance.getPriority());
  assertEquals("Clean up",historicTaskInstance.getName());
  assertEquals("Schedule an engineering meeting for next week with the new hire.",historicTaskInstance.getDescription());
  assertEquals(dueDateCal.getTime(),historicTaskInstance.getDueDate());
  assertEquals("kermit",historicTaskInstance.getAssignee());
  assertEquals(TaskEntity.DELETE_REASON_COMPLETED,historicTaskInstance.getDeleteReason());
  assertEquals(taskDefinitionKey,historicTaskInstance.getTaskDefinitionKey());
  assertNotNull(historicTaskInstance.getEndTime());
  assertNotNull(historicTaskInstance.getDurationInMillis());
  historyService.deleteHistoricTaskInstance(taskId);
  assertEquals(0,historyService.createHistoricTaskInstanceQuery().count());
}
