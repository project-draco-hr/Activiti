{
  DeploymentImpl deployment=this.deployment;
  PersistenceSession persistenceSession=commandContext.getPersistenceSession();
  List<DeploymentImpl> deployments=persistenceSession.findDeploymentsByName(deployment.getName());
  if (deployments.isEmpty() || deploymentsDiffer(deployment,deployments.get(0))) {
    insertDeployment(persistenceSession);
  }
 else {
    deployment=deployments.get(0);
  }
  try {
    deployerManager.deploy(deployment,persistenceSession);
  }
 catch (  RuntimeException e) {
    persistenceSession.deleteDeployment(deployment.getId());
    throw e;
  }
  return deployment;
}
