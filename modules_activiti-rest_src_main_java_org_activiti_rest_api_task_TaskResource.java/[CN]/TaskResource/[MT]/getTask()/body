{
  if (authenticate() == false)   return null;
  String taskId=(String)getRequest().getAttributes().get("taskId");
  Task task=ActivitiUtil.getTaskService().createTaskQuery().taskId(taskId).singleResult();
  if (task == null) {
    throw new ActivitiObjectNotFoundException("Task not found for id " + taskId,Task.class);
  }
  TaskResponse response=new TaskResponse(task);
  TaskFormData taskFormData=ActivitiUtil.getFormService().getTaskFormData(taskId);
  if (taskFormData != null) {
    response.setFormResourceKey(taskFormData.getFormKey());
  }
  List<Task> subTaskList=ActivitiUtil.getTaskService().getSubTasks(task.getId());
  if (subTaskList != null) {
    for (    Task subTask : subTaskList) {
      SubTaskResponse subTaskResponse=new SubTaskResponse(subTask);
      response.addSubTask(subTaskResponse);
    }
  }
  List<IdentityLink> linkList=ActivitiUtil.getTaskService().getIdentityLinksForTask(task.getId());
  if (linkList != null) {
    for (    IdentityLink identityLink : linkList) {
      IdentityLinkResponse linkResponse=new IdentityLinkResponse(identityLink);
      response.addIdentityLink(linkResponse);
    }
  }
  List<Attachment> attachmentList=null;
  if (task.getProcessInstanceId() != null && task.getProcessInstanceId().length() > 0) {
    attachmentList=ActivitiUtil.getTaskService().getProcessInstanceAttachments(task.getProcessInstanceId());
  }
 else {
    attachmentList=ActivitiUtil.getTaskService().getTaskAttachments(task.getId());
  }
  if (attachmentList != null) {
    for (    Attachment attachment : attachmentList) {
      AttachmentResponse attachmentResponse=new AttachmentResponse(attachment);
      response.addAttachment(attachmentResponse);
    }
  }
  return response;
}
