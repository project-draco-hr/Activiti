{
  JobEntity job=Context.getCommandContext().getJobEntityManager().findJobById(jobId);
  job.setRetries(job.getRetries() - 1);
  job.setLockOwner(null);
  job.setLockExpirationTime(null);
  if (exception != null) {
    job.setExceptionMessage(exception.getMessage());
    job.setExceptionStacktrace(getExceptionStacktrace());
  }
  ActivitiEventDispatcher eventDispatcher=commandContext.getEventDispatcher();
  if (eventDispatcher.isEnabled()) {
    eventDispatcher.dispatchEvent(ActivitiEventBuilder.createEntityEvent(ActivitiEventType.ENTITY_UPDATED,job));
    eventDispatcher.dispatchEvent(ActivitiEventBuilder.createEntityEvent(ActivitiEventType.JOB_RETRIES_DECREMENTED,job));
  }
  JobExecutor jobExecutor=Context.getProcessEngineConfiguration().getJobExecutor();
  MessageAddedNotification messageAddedNotification=new MessageAddedNotification(jobExecutor);
  TransactionContext transactionContext=commandContext.getTransactionContext();
  transactionContext.addTransactionListener(TransactionState.COMMITTED,messageAddedNotification);
  return null;
}
