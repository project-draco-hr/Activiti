{
  Assert.assertTrue(muleContext.isStarted());
  RepositoryService repositoryService=muleContext.getRegistry().get("repositoryService");
  Deployment deployment=repositoryService.createDeployment().addClasspathResource("org/activiti/mule/testVM.bpmn20.xml").deploy();
  RuntimeService runtimeService=muleContext.getRegistry().get("runtimeService");
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("muleProcess");
  Assert.assertFalse(processInstance.isEnded());
  Object result=runtimeService.getVariable(processInstance.getProcessInstanceId(),"theVariable");
  Assert.assertEquals(30,result);
  runtimeService.deleteProcessInstance(processInstance.getId(),"test");
  ProcessEngine processEngine=muleContext.getRegistry().get("processEngine");
  processEngine.getHistoryService().deleteHistoricProcessInstance(processInstance.getId());
  repositoryService.deleteDeployment(deployment.getId());
  assertAndEnsureCleanDb(processEngine);
}
