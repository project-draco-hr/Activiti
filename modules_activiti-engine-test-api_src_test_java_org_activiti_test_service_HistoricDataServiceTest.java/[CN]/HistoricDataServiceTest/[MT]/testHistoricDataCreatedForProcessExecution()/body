{
  final ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("oneTaskProcess");
  try {
    HistoricProcessInstance historicProcessInstance=historicDataService.findHistoricProcessInstance(processInstance.getId());
    assertNotNull(historicProcessInstance);
    assertEquals(processInstance.getId(),historicProcessInstance.getProcessInstanceId());
    assertEquals(processInstance.getProcessDefinitionId(),historicProcessInstance.getProcessDefinitionId());
    assertNotNull(historicProcessInstance.getStartTime());
    assertNull(historicProcessInstance.getEndTime());
    assertNull(historicProcessInstance.getDurationInMillis());
    List<Task> tasks=taskService.createTaskQuery().processInstance(processInstance.getId()).list();
    assertEquals(1,tasks.size());
    taskService.complete(tasks.get(0).getId());
    historicProcessInstance=historicDataService.findHistoricProcessInstance(processInstance.getId());
    assertNotNull(historicProcessInstance);
    assertEquals(processInstance.getId(),historicProcessInstance.getProcessInstanceId());
    assertEquals(processInstance.getProcessDefinitionId(),historicProcessInstance.getProcessDefinitionId());
    assertNotNull(historicProcessInstance.getStartTime());
    assertNotNull(historicProcessInstance.getEndTime());
    assertNotNull(historicProcessInstance.getDurationInMillis());
  }
  finally {
    processEngineConfiguration.getCommandExecutor().execute(new Command<Object>(){
      public Object execute(      CommandContext commandContext){
        commandContext.getHistorySession().deleteHistoricProcessInstance(processInstance.getId());
        return null;
      }
    }
);
  }
}
