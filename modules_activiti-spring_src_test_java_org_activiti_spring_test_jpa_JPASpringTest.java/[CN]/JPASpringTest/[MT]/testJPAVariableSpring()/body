{
  ClassPathXmlApplicationContext applicationContext=new ClassPathXmlApplicationContext("org/activiti/spring/test/jpa/JPASpringTest-context.xml");
  RuntimeService runtimeService=(RuntimeService)applicationContext.getBean("runtimeService");
  TaskService taskService=(TaskService)applicationContext.getBean("taskService");
  RepositoryService repositoryService=(RepositoryService)applicationContext.getBean("repositoryService");
  Map<String,Object> variables=new HashMap<String,Object>();
  variables.put("customerName","John Doe");
  variables.put("amount",15000L);
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("LoanRequestProcess",variables);
  Object value=runtimeService.getVariable(processInstance.getId(),"loanRequest");
  assertNotNull(value);
  assertTrue(value instanceof LoanRequest);
  LoanRequest request=(LoanRequest)value;
  assertEquals("John Doe",request.getCustomerName());
  assertEquals(15000L,request.getAmount().longValue());
  assertFalse(request.isApproved());
  variables=new HashMap<String,Object>();
  variables.put("approvedByManager",Boolean.TRUE);
  Task task=taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
  assertNotNull(task);
  taskService.complete(task.getId(),variables);
  assertEquals(0,runtimeService.createProcessInstanceQuery().processInstanceId(processInstance.getId()).count());
  variables=new HashMap<String,Object>();
  variables.put("customerName","Jane Doe");
  variables.put("amount",50000L);
  processInstance=runtimeService.startProcessInstanceByKey("LoanRequestProcess",variables);
  value=runtimeService.getVariable(processInstance.getId(),"loanRequest");
  assertNotNull(value);
  assertTrue(value instanceof LoanRequest);
  request=(LoanRequest)value;
  assertEquals("Jane Doe",request.getCustomerName());
  assertEquals(50000L,request.getAmount().longValue());
  assertFalse(request.isApproved());
  variables=new HashMap<String,Object>();
  variables.put("approvedByManager",Boolean.FALSE);
  task=taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
  assertNotNull(task);
  taskService.complete(task.getId(),variables);
  runtimeService.getVariable(processInstance.getId(),"loanRequest");
  request=(LoanRequest)value;
  assertFalse(request.isApproved());
  task=taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
  assertNotNull(task);
  assertEquals("Send rejection letter",task.getName());
  String deploymentId=repositoryService.createProcessDefinitionQuery().processDefinitionKey("LoanRequestProcess").singleResult().getDeploymentId();
  repositoryService.deleteDeploymentCascade(deploymentId);
}
