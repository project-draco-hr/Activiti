{
  if (isHistoryLevelAtLeast(HistoryLevel.ACTIVITY)) {
    if (activityId == null) {
      return;
    }
    List<HistoricActivityInstanceEntity> cachedHistoricActivityInstances=getDbSqlSession().findInCache(HistoricActivityInstanceEntity.class);
    for (    HistoricActivityInstanceEntity cachedHistoricActivityInstance : cachedHistoricActivityInstances) {
      if (executionId.equals(cachedHistoricActivityInstance.getExecutionId()) && (activityId.equals(cachedHistoricActivityInstance.getActivityId())) && (cachedHistoricActivityInstance.getEndTime() == null)) {
        cachedHistoricActivityInstance.markEnded(null);
        ProcessEngineConfigurationImpl config=getProcessEngineConfiguration();
        if (config != null && config.getEventDispatcher().isEnabled()) {
          config.getEventDispatcher().dispatchEvent(ActivitiEventBuilder.createEntityEvent(ActivitiEventType.HISTORIC_ACTIVITY_INSTANCE_ENDED,cachedHistoricActivityInstance));
        }
        return;
      }
    }
  }
}
