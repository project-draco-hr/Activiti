{
  ActivityDrawInstruction drawInstruction=activityDrawInstructions.get(flowNode.getClass());
  if (drawInstruction != null) {
    drawInstruction.draw(processDiagramCanvas,bpmnModel,flowNode);
    boolean multiInstanceSequential=false, multiInstanceParallel=false, collapsed=false;
    if (flowNode instanceof Activity) {
      Activity activity=(Activity)flowNode;
      MultiInstanceLoopCharacteristics multiInstanceLoopCharacteristics=activity.getLoopCharacteristics();
      if (multiInstanceLoopCharacteristics != null) {
        multiInstanceSequential=multiInstanceLoopCharacteristics.isSequential();
        multiInstanceParallel=!multiInstanceSequential;
      }
    }
    GraphicInfo graphicInfo=bpmnModel.getGraphicInfo(flowNode.getId());
    if (flowNode instanceof SubProcess) {
      collapsed=graphicInfo.getExpanded() != null && graphicInfo.getExpanded() == false;
    }
 else     if (flowNode instanceof CallActivity) {
      collapsed=true;
    }
    processDiagramCanvas.drawActivityMarkers((int)graphicInfo.getX(),(int)graphicInfo.getY(),(int)graphicInfo.getWidth(),(int)graphicInfo.getHeight(),multiInstanceSequential,multiInstanceParallel,collapsed);
    if (highLightedActivities.contains(flowNode.getId())) {
      drawHighLight(processDiagramCanvas,bpmnModel.getGraphicInfo(flowNode.getId()));
    }
  }
  for (  SequenceFlow sequenceFlow : flowNode.getOutgoingFlows()) {
    boolean highLighted=(highLightedFlows.contains(sequenceFlow.getId()));
    boolean isDefault=sequenceFlow.getConditionExpression() == null && (flowNode instanceof Gateway);
    boolean drawConditionalIndicator=sequenceFlow.getConditionExpression() != null && !(flowNode instanceof Gateway);
    List<GraphicInfo> graphicInfoList=bpmnModel.getFlowLocationGraphicInfo(sequenceFlow.getId());
    int xPoints[]=new int[graphicInfoList.size()];
    int yPoints[]=new int[graphicInfoList.size()];
    for (int i=1; i < graphicInfoList.size(); i++) {
      GraphicInfo graphicInfo=graphicInfoList.get(i);
      GraphicInfo previousGraphicInfo=graphicInfoList.get(i - 1);
      if (i == 1) {
        xPoints[0]=(int)previousGraphicInfo.getX();
        yPoints[0]=(int)previousGraphicInfo.getY();
      }
      xPoints[i]=(int)graphicInfo.getX();
      yPoints[i]=(int)graphicInfo.getY();
    }
    processDiagramCanvas.drawSequenceflow(xPoints,yPoints,drawConditionalIndicator,isDefault,highLighted);
    GraphicInfo labelGraphicInfo=bpmnModel.getLabelGraphicInfo(sequenceFlow.getId());
    if (labelGraphicInfo != null) {
      GraphicInfo lineCenter=getLineCenter(graphicInfoList);
      processDiagramCanvas.drawLabel(sequenceFlow.getName(),(int)lineCenter.getX() + (int)labelGraphicInfo.getX(),(int)(lineCenter.getY() + (int)labelGraphicInfo.getY() - labelGraphicInfo.getHeight()),(int)labelGraphicInfo.getWidth(),(int)labelGraphicInfo.getHeight(),false);
    }
  }
  if (flowNode instanceof FlowElementsContainer) {
    for (    FlowElement nestedFlowElement : ((FlowElementsContainer)flowNode).getFlowElements()) {
      if (nestedFlowElement instanceof FlowNode) {
        drawActivity(processDiagramCanvas,bpmnModel,(FlowNode)nestedFlowElement,highLightedActivities,highLightedFlows);
      }
    }
  }
}
