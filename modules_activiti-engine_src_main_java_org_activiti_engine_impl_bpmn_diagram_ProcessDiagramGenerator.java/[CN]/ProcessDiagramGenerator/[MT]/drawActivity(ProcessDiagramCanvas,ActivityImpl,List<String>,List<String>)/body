{
  String type=(String)activity.getProperty("type");
  ActivityDrawInstruction drawInstruction=activityDrawInstructions.get(type);
  if (drawInstruction != null) {
    drawInstruction.draw(processDiagramCanvas,activity);
    boolean multiInstanceSequential=false, multiInstanceParallel=false, collapsed=false;
    String multiInstance=(String)activity.getProperty("multiInstance");
    if (multiInstance != null) {
      if ("sequential".equals(multiInstance)) {
        multiInstanceSequential=true;
      }
 else {
        multiInstanceParallel=true;
      }
    }
    collapsed=(activity.getActivityBehavior() instanceof CallActivityBehavior);
    Boolean expanded=(Boolean)activity.getProperty(BpmnParse.PROPERTYNAME_ISEXPANDED);
    if (expanded != null) {
      collapsed=!expanded;
    }
    processDiagramCanvas.drawActivityMarkers(activity.getX(),activity.getY(),activity.getWidth(),activity.getHeight(),multiInstanceSequential,multiInstanceParallel,collapsed);
    if (highLightedActivities.contains(activity.getId())) {
      drawHighLight(processDiagramCanvas,activity);
    }
  }
  for (  PvmTransition sequenceFlow : activity.getOutgoingTransitions()) {
    boolean highLighted=(highLightedFlows.contains(sequenceFlow.getId()));
    boolean drawConditionalIndicator=sequenceFlow.getProperty(BpmnParse.PROPERTYNAME_CONDITION) != null && !((String)activity.getProperty("type")).toLowerCase().contains("gateway");
    boolean isDefault=sequenceFlow.getId().equals(activity.getProperty("default")) && ((String)activity.getProperty("type")).toLowerCase().contains("gateway");
    List<Integer> waypoints=((TransitionImpl)sequenceFlow).getWaypoints();
    int xPoints[]=new int[waypoints.size() / 2];
    int yPoints[]=new int[waypoints.size() / 2];
    for (int i=0, j=0; i < waypoints.size(); i+=2, j++) {
      xPoints[j]=waypoints.get(i);
      yPoints[j]=waypoints.get(i + 1);
    }
    processDiagramCanvas.drawSequenceflow(xPoints,yPoints,drawConditionalIndicator,isDefault,highLighted);
  }
  for (  ActivityImpl nestedActivity : activity.getActivities()) {
    drawActivity(processDiagramCanvas,nestedActivity,highLightedActivities,highLightedFlows);
  }
}
