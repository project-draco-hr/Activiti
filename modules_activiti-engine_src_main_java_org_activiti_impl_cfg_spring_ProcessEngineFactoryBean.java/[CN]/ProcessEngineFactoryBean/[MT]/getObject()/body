{
  factory.setLocalTransactions(transactionManager == null);
  if (transactionManager != null) {
    DefaultCommandExecutor commandExecutor=new DefaultCommandExecutor(factory.getCommandContextFactory());
    commandExecutor.addCommandInterceptor(new CommandInterceptor(){
      public <T>T invoke(      final CommandExecutor next,      final Command<T> command){
        @SuppressWarnings("unchecked") T result=(T)new TransactionTemplate(transactionManager).execute(new TransactionCallback(){
          public Object doInTransaction(          TransactionStatus status){
            return next.execute(command);
          }
        }
);
        return result;
      }
    }
);
    factory.setCommandExecutor(commandExecutor);
  }
  processEngine=factory.createProcessEngine();
  refreshProcessResources(processEngine.getRepositoryService(),processResources);
  return processEngine;
}
