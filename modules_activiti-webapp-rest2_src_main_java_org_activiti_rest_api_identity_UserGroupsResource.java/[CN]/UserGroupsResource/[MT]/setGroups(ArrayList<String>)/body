{
  if (authenticate() == false)   return null;
  String userId=(String)getRequest().getAttributes().get("userId");
  if (userId == null) {
    throw new ActivitiException("No userId provided");
  }
  if (groupIds == null) {
    throw new ActivitiException("No groupIds provided");
  }
  IdentityService identityService=ActivitiUtil.getIdentityService();
  if (identityService.createUserQuery().userId(userId).singleResult() == null)   throw new ActivitiException("The user '" + userId + " does not exist.");
  for (  String groupId : groupIds) {
    if (identityService.createGroupQuery().groupId(groupId).singleResult() == null)     throw new ActivitiException("Group '" + groupId + "' does not exist.");
  }
  for (  String groupId : groupIds) {
    if (identityService.createUserQuery().userId(userId).memberOfGroup(groupId).singleResult() == null)     identityService.createMembership(userId,groupId);
  }
  return new StateResponse().setSuccess(true);
}
