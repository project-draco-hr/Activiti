{
  int loopCounter=getLoopVariable(execution,LOOP_COUNTER);
  int nrOfInstances=getLoopVariable(execution,NUMBER_OF_INSTANCES);
  int nrOfCompletedInstances=getLoopVariable(execution,NUMBER_OF_COMPLETED_INSTANCES);
  int nrOfActiveInstances=getLoopVariable(execution,NUMBER_OF_ACTIVE_INSTANCES);
  if (isSequential) {
    loopCounter++;
    nrOfCompletedInstances++;
    setLoopVariable(execution,LOOP_COUNTER,loopCounter);
    setLoopVariable(execution,NUMBER_OF_COMPLETED_INSTANCES,nrOfCompletedInstances);
    logLoopDetails(execution,"instance completed",loopCounter,nrOfCompletedInstances,nrOfActiveInstances,nrOfInstances);
    if (loopCounter == nrOfInstances || completionConditionSatisfied(execution)) {
      super.leave(execution);
    }
 else {
      try {
        activityBehavior.execute(execution);
      }
 catch (      Exception e) {
        throw new ActivitiException("Could not execute inner activity behavior of multi instance behavior",e);
      }
    }
  }
 else {
    nrOfCompletedInstances++;
    nrOfActiveInstances--;
    setLoopVariable(execution.getParent(),NUMBER_OF_COMPLETED_INSTANCES,nrOfCompletedInstances);
    setLoopVariable(execution.getParent(),NUMBER_OF_ACTIVE_INSTANCES,nrOfActiveInstances);
    logLoopDetails(execution,"instance completed",loopCounter,nrOfCompletedInstances,nrOfActiveInstances,nrOfInstances);
    execution.inactivate();
    ((ExecutionEntity)execution.getParent()).forceUpdate();
    List<ActivityExecution> joinedExecutions=execution.findInactiveConcurrentExecutions(execution.getActivity());
    if (joinedExecutions.size() == nrOfInstances || completionConditionSatisfied(execution)) {
      List<ExecutionEntity> executionsToRemove=new ArrayList<ExecutionEntity>();
      for (      ActivityExecution childExecution : execution.getParent().getExecutions()) {
        if (childExecution.isActive()) {
          executionsToRemove.add((ExecutionEntity)childExecution);
        }
      }
      for (      ExecutionEntity executionToRemove : executionsToRemove) {
        if (LOGGER.isLoggable(Level.FINE)) {
          LOGGER.fine("Execution " + executionToRemove + " still active, "+ "but multi-instance is completed. Removing this execution.");
        }
        executionToRemove.inactivate();
        executionToRemove.remove();
      }
      execution.takeAll(execution.getActivity().getOutgoingTransitions(),joinedExecutions);
    }
 else {
    }
  }
}
