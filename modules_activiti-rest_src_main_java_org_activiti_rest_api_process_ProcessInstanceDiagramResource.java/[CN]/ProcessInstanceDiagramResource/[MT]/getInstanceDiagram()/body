{
  String processInstanceId=(String)getRequest().getAttributes().get("processInstanceId");
  if (processInstanceId == null) {
    throw new ActivitiIllegalArgumentException("No process instance id provided");
  }
  ExecutionEntity pi=(ExecutionEntity)ActivitiUtil.getRuntimeService().createProcessInstanceQuery().processInstanceId(processInstanceId).singleResult();
  if (pi == null) {
    throw new ActivitiObjectNotFoundException("Process instance with id" + processInstanceId + " could not be found",ProcessInstance.class);
  }
  ProcessDefinitionEntity pde=(ProcessDefinitionEntity)((RepositoryServiceImpl)ActivitiUtil.getRepositoryService()).getDeployedProcessDefinition(pi.getProcessDefinitionId());
  if (pde != null && pde.isGraphicalNotationDefined()) {
    InputStream resource=ProcessDiagramGenerator.generateDiagram(pde,"png",ActivitiUtil.getRuntimeService().getActiveActivityIds(processInstanceId));
    InputRepresentation output=new InputRepresentation(resource,MediaType.IMAGE_PNG);
    return output;
  }
 else {
    throw new ActivitiException("Process instance with id " + processInstanceId + " has no graphic description");
  }
}
