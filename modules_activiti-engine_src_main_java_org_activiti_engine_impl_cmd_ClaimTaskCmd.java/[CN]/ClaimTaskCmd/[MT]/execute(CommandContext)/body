{
  if (taskId == null) {
    throw new ActivitiException("taskId is null");
  }
  TaskSession taskSession=commandContext.getTaskSession();
  IdentitySession identitySession=commandContext.getIdentitySession();
  TaskEntity task=taskSession.findTaskById(taskId);
  if (task == null) {
    throw new ActivitiException("Cannot find task with id " + taskId);
  }
  if (userId != null) {
    if (task.getAssignee() != null) {
      if (!task.getAssignee().equals(userId)) {
        throw new ActivitiException("Task " + taskId + " is already claimed by someone else");
      }
    }
 else {
      if (identitySession.isValidUser(userId)) {
        task.setAssignee(userId);
      }
 else {
        throw new ActivitiException("Cannot claim task " + taskId + ": user "+ userId+ " unknown.");
      }
    }
  }
 else {
    task.setAssignee(null);
  }
  return null;
}
