{
  ProcessInstance processInstance=getProcessInstanceFromRequest();
  ProcessDefinitionEntity pde=(ProcessDefinitionEntity)((RepositoryServiceImpl)ActivitiUtil.getRepositoryService()).getDeployedProcessDefinition(processInstance.getProcessDefinitionId());
  if (pde != null && pde.isGraphicalNotationDefined()) {
    BpmnModel bpmnModel=ActivitiUtil.getRepositoryService().getBpmnModel(pde.getId());
    InputStream resource=ProcessDiagramGenerator.generateDiagram(bpmnModel,"png",ActivitiUtil.getRuntimeService().getActiveActivityIds(processInstance.getId()));
    InputRepresentation output=new InputRepresentation(resource,MediaType.IMAGE_PNG);
    return output;
  }
 else {
    throw new ActivitiIllegalArgumentException("Process instance with id '" + processInstance.getId() + "' has no graphical notation defined.");
  }
}
