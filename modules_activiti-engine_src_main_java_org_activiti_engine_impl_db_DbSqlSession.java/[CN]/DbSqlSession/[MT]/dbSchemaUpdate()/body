{
  String feedback=null;
  if (isEngineTablePresent()) {
    PropertyEntity dbVersionProperty=selectById(PropertyEntity.class,"schema.version");
    String dbVersion=dbVersionProperty.getValue();
    if (dbVersion.endsWith("-SNAPSHOT")) {
      dbVersion=dbVersion.substring(0,dbVersion.length() - "-SNAPSHOT".length());
    }
    try {
      JdbcConnection connection=new JdbcConnection(sqlSession.getConnection());
      Database database=DatabaseFactory.getInstance().findCorrectDatabaseImplementation(connection);
      database.setDefaultSchemaName(this.connectionMetadataDefaultSchema);
      Liquibase liquibase=new Liquibase("org/activiti/db/liquibase/activiti-upgrade-" + dbVersion + ".xml",new ClassLoaderResourceAccessor(),database);
      liquibase.getDatabase().setDatabaseChangeLogLockTableName("ACT_" + liquibase.getDatabase().getDatabaseChangeLogLockTableName());
      liquibase.update("production");
    }
 catch (    Exception e) {
      throw new ActivitiException("Error creating Activiti tables",e);
    }
    feedback="upgraded Activiti from " + dbVersion + " to "+ ProcessEngine.VERSION;
  }
 else {
    dbSchemaCreateEngine();
  }
  return feedback;
}
