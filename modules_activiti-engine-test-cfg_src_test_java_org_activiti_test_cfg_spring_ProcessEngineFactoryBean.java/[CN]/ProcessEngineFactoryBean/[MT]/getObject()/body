{
  Assert.state(dataBaseName != null,"A database name must be provided (e.g. 'h2')");
  ProcessEngineFactory factory=new ProcessEngineFactory();
  factory.setDbSchemaStrategy(dbSchemaStrategy);
  factory.setJobExecutorAutoActivate(jobExecutorAutoActivate);
  factory.setProcessEngineName(processEngineName);
  factory.setDataSource(dataSource);
  factory.setDataBaseName(dataBaseName);
  factory.setLocalTransactions(transactionManager == null);
  if (transactionManager != null) {
    DefaultCommandExecutor commandExecutor=new DefaultCommandExecutor(factory.getCommandContextFactory());
    commandExecutor.addCommandInterceptor(new CommandInterceptor(){
      public <T>T invoke(      final CommandExecutor next,      final Command<T> command){
        @SuppressWarnings("unchecked") T result=(T)new TransactionTemplate(transactionManager).execute(new TransactionCallback(){
          public Object doInTransaction(          TransactionStatus status){
            return next.execute(command);
          }
        }
);
        return result;
      }
    }
);
    factory.setCommandExecutor(commandExecutor);
  }
  processEngine=factory.createProcessEngine();
  return processEngine;
}
