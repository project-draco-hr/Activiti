{
  InputStream inputStream=null;
  try {
    inputStream=ReflectUtil.getResourceAsStream("org/activiti/db/cycle/ibatis/activiti.ibatis.mem.conf.xml");
    Environment environment=new Environment("default",transactionFactory,dataSource);
    XMLConfigBuilder parser=new XMLConfigBuilder(inputStream);
    Configuration configuration=parser.getConfiguration();
    configuration.setEnvironment(environment);
    configuration=parser.parse();
    return new DefaultSqlSessionFactory(configuration);
  }
 catch (  Exception e) {
    throw new ActivitiException("Error while building ibatis SqlSessionFactory: " + e.getMessage(),e);
  }
 finally {
    IoUtil.closeSilently(inputStream);
  }
}
