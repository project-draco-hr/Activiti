{
  if (dbFactories.get(processEngineName) == null) {
synchronized (dbFactories) {
      if (dbFactories.get(processEngineName) == null) {
        ProcessEngineImpl engineImpl=(ProcessEngineImpl)ProcessEngines.getProcessEngine(processEngineName);
        ProcessEngineConfigurationImpl processEngineConfiguration=engineImpl.getProcessEngineConfiguration();
        DataSource dataSource=processEngineConfiguration.getDataSource();
        TransactionFactory transactionFactory=processEngineConfiguration.getTransactionFactory();
        SqlSessionFactory sqlSessionFactory=createSessionFactory(dataSource,transactionFactory);
        DbSqlSessionFactory factory=new DbSqlSessionFactory();
        factory.setDatabaseType(processEngineConfiguration.getDatabaseType());
        factory.setIdGenerator(processEngineConfiguration.getIdGenerator());
        factory.setSqlSessionFactory(sqlSessionFactory);
        dbFactories.put(processEngineName,factory);
      }
    }
  }
  return dbFactories.get(processEngineName).getSqlSessionFactory();
}
