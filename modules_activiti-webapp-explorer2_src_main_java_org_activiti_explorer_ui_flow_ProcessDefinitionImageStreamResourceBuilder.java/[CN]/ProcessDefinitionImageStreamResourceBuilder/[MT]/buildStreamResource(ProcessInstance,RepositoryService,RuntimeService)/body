{
  StreamResource imageResource=null;
  ProcessDefinitionEntity processDefinition=(ProcessDefinitionEntity)((RepositoryServiceImpl)repositoryService).getDeployedProcessDefinition(processInstance.getProcessDefinitionId());
  if (processDefinition != null && processDefinition.isGraphicalNotationDefined()) {
    InputStream definitionImageStream=ProcessDiagramGenerator.generateDiagram(processDefinition,"png",runtimeService.getActiveActivityIds(processInstance.getId()));
    StreamSource streamSource=new InputStreamStreamSource(definitionImageStream);
    String imageExtension=extractImageExtension(processDefinition.getDiagramResourceName());
    String fileName=processInstance.getId() + UUID.randomUUID() + "."+ imageExtension;
    imageResource=new StreamResource(streamSource,fileName,ExplorerApplication.getCurrent());
  }
  return imageResource;
}
