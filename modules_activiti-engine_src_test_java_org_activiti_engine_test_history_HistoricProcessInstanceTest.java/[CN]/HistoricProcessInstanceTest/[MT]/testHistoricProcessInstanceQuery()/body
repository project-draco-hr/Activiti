{
  Calendar startTime=Calendar.getInstance();
  ClockUtil.setCurrentTime(startTime.getTime());
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("oneTaskProcess","businessKey123");
  runtimeService.addUserIdentityLink(processInstance.getId(),"kermit","someType");
  Calendar hourAgo=Calendar.getInstance();
  hourAgo.add(Calendar.HOUR_OF_DAY,-1);
  Calendar hourFromNow=Calendar.getInstance();
  hourFromNow.add(Calendar.HOUR_OF_DAY,1);
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedBefore(hourAgo.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedBefore(hourFromNow.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedAfter(hourAgo.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedAfter(hourFromNow.getTime()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().startedBefore(hourFromNow.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().startedBefore(hourAgo.getTime()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().startedAfter(hourAgo.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().startedAfter(hourFromNow.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finished().count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().processInstanceId(processInstance.getId()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().processDefinitionId(processInstance.getProcessDefinitionId()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().processDefinitionKey("oneTaskProcess").count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().processInstanceBusinessKey("businessKey123").count());
  List<String> exludeIds=new ArrayList<String>();
  exludeIds.add("unexistingProcessDefinition");
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().processDefinitionKeyNotIn(exludeIds).count());
  exludeIds.add("oneTaskProcess");
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().processDefinitionKeyNotIn(exludeIds).count());
  taskService.complete(taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult().getId());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().finished().count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedBefore(hourAgo.getTime()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().finishedBefore(hourFromNow.getTime()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().finishedAfter(hourAgo.getTime()).count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().finishedAfter(hourFromNow.getTime()).count());
  assertEquals(1,historyService.createHistoricProcessInstanceQuery().involvedUser("kermit").count());
  assertEquals(0,historyService.createHistoricProcessInstanceQuery().involvedUser("gonzo").count());
}
