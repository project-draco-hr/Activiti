{
  ProcessInstance processInstance=runtimeService.startProcessInstanceByKey("oneTaskProcess");
  Task task=taskService.createTaskQuery().processInstanceId(processInstance.getId()).singleResult();
  assertNotNull(task);
  Attachment attachment=taskService.createAttachment("test",task.getId(),processInstance.getId(),"attachment name","description","http://activiti.org");
  assertEquals(1,listener.getEventsReceived().size());
  ActivitiEntityEvent event=(ActivitiEntityEvent)listener.getEventsReceived().get(0);
  assertEquals(ActivitiEventType.ENTITY_CREATED,event.getType());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  Attachment attachmentFromEvent=(Attachment)event.getEntity();
  assertEquals(attachment.getId(),attachmentFromEvent.getId());
  listener.clearEventsReceived();
  attachment=taskService.createAttachment("test",task.getId(),processInstance.getId(),"attachment name","description",new ByteArrayInputStream("test".getBytes()));
  assertEquals(1,listener.getEventsReceived().size());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(0);
  assertEquals(ActivitiEventType.ENTITY_CREATED,event.getType());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  attachmentFromEvent=(Attachment)event.getEntity();
  assertEquals(attachment.getId(),attachmentFromEvent.getId());
  listener.clearEventsReceived();
  attachment=taskService.getAttachment(attachment.getId());
  attachment.setDescription("Description");
  taskService.saveAttachment(attachment);
  assertEquals(1,listener.getEventsReceived().size());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(0);
  assertEquals(ActivitiEventType.ENTITY_UPDATED,event.getType());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  attachmentFromEvent=(Attachment)event.getEntity();
  assertEquals(attachment.getId(),attachmentFromEvent.getId());
  assertEquals("Description",attachmentFromEvent.getDescription());
  listener.clearEventsReceived();
  taskService.deleteAttachment(attachment.getId());
  assertEquals(1,listener.getEventsReceived().size());
  event=(ActivitiEntityEvent)listener.getEventsReceived().get(0);
  assertEquals(ActivitiEventType.ENTITY_DELETED,event.getType());
  assertEquals(processInstance.getId(),event.getProcessInstanceId());
  assertEquals(processInstance.getId(),event.getExecutionId());
  assertEquals(processInstance.getProcessDefinitionId(),event.getProcessDefinitionId());
  attachmentFromEvent=(Attachment)event.getEntity();
  assertEquals(attachment.getId(),attachmentFromEvent.getId());
}
