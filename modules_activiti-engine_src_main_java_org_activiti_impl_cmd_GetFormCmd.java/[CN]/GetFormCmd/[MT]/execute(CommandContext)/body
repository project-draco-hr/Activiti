{
  PersistenceSession persistenceSession=commandContext.getPersistenceSession();
  RepositorySession repositorySession=commandContext.getRepositorySession();
  ProcessDefinitionImpl processDefinition=null;
  TaskImpl task=null;
  ExecutionImpl execution=null;
  FormReference formReference=null;
  if (taskId != null) {
    task=persistenceSession.findTask(taskId);
    if (task == null) {
      throw new ActivitiException("No task found for id = '" + taskId + "'");
    }
    execution=task.getExecution();
    processDefinition=repositorySession.findDeployedProcessDefinitionById(task.getProcessDefinitionId());
    formReference=execution.getActivity().getFormReference();
  }
 else   if (processDefinitionId != null) {
    processDefinition=repositorySession.findDeployedProcessDefinitionById(processDefinitionId);
    if (processDefinition == null) {
      throw new ActivitiException("No process definition found for id = '" + processDefinitionId + "'");
    }
    formReference=processDefinition.getInitial().getFormReference();
  }
 else   if (processDefinitionKey != null) {
    processDefinition=repositorySession.findDeployedLatestProcessDefinitionByKey(processDefinitionKey);
    if (processDefinition == null) {
      throw new ActivitiException("No process definition found for key '" + processDefinitionKey + "'");
    }
    formReference=processDefinition.getInitial().getFormReference();
  }
  String deploymentId=processDefinition.getDeploymentId();
  DeploymentEntity deployment=repositorySession.findDeploymentById(deploymentId);
  Object result=null;
  if (formReference != null) {
    String formLanguage=formReference.getLanguage();
    String form=formReference.getForm();
    String formTemplateString=getFormTemplateString(form,deployment);
    ScriptingEngines scriptingEngines=commandContext.getProcessEngineConfiguration().getScriptingEngines();
    result=scriptingEngines.evaluate(formTemplateString,formLanguage,execution);
  }
  return result;
}
