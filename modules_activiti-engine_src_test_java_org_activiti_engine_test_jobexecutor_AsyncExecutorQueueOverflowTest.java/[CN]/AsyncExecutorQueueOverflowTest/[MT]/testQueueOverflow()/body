{
  ProcessEngine processEngine=initProcessEngineWithJobQueueSize(100);
  Date startDate=new Date(1453273200000L);
  processEngine.getProcessEngineConfiguration().getClock().setCurrentTime(startDate);
  final RepositoryService repositoryService=processEngine.getRepositoryService();
  final RuntimeService runtimeService=processEngine.getRuntimeService();
  final HistoryService historyService=processEngine.getHistoryService();
  repositoryService.createDeployment().addClasspathResource("org/activiti/engine/test/jobexecutor/AsyncExecutorQueueOverflowTest.bpmn20.xml").deploy();
  int nrOfProcessInstances=300;
  for (int i=0; i < nrOfProcessInstances; i++) {
    runtimeService.startProcessInstanceByKey("testAsyncExecutor");
  }
  Assert.assertEquals(nrOfProcessInstances,runtimeService.createProcessInstanceQuery().count());
  Date mondayMorningDate=new Date(1453280460000L);
  processEngine.getProcessEngineConfiguration().getClock().setCurrentTime(mondayMorningDate);
  boolean allJobsProcessed=false;
  while (!allJobsProcessed) {
    long count=historyService.createHistoricActivityInstanceQuery().activityId("theServiceTask").unfinished().count();
    System.out.println("COUNT = " + count);
    allJobsProcessed=count == nrOfProcessInstances;
    if (!allJobsProcessed) {
      Thread.sleep(1000L);
    }
  }
  Assert.assertEquals(nrOfProcessInstances,runtimeService.createProcessInstanceQuery().count());
  Assert.assertEquals(nrOfProcessInstances,historyService.createHistoricActivityInstanceQuery().activityId("theScriptTask").finished().count());
  Assert.assertEquals(nrOfProcessInstances,historyService.createHistoricActivityInstanceQuery().activityId("theServiceTask").unfinished().count());
  processEngine.close();
}
