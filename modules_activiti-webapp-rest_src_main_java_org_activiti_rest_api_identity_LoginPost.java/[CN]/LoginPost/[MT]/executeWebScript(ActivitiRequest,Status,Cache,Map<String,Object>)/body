{
  Content c=req.getWebScriptRequest().getContent();
  if (c == null) {
    throw new WebScriptException(Status.STATUS_BAD_REQUEST,"Missing POST body.");
  }
  try {
    JSONObject json=new JSONObject(c.getContent());
    String userId=json.getString("userId");
    String password=json.getString("password");
    if (userId == null || userId.length() == 0) {
      throw new WebScriptException(HttpServletResponse.SC_BAD_REQUEST,"Username not specified");
    }
    if (password == null) {
      throw new WebScriptException(HttpServletResponse.SC_BAD_REQUEST,"Password not specified");
    }
    String engineName=config.getEngine();
    ProcessEngine pe=ProcessEngines.getProcessEngine(engineName);
    if (pe != null) {
      if (!pe.getIdentityService().checkPassword(userId,password)) {
        throw new WebScriptException(HttpServletResponse.SC_FORBIDDEN,"Username and password does not match.");
      }
    }
 else {
      String message;
      ProcessEngineInfo pei=ProcessEngines.getProcessEngineInfo(engineName);
      if (pei != null) {
        message=pei.getException();
      }
 else {
        message="Can't find process engine named '" + engineName + "' which is needed to authenticate username and password.";
        List<ProcessEngineInfo> processEngineInfos=ProcessEngines.getProcessEngineInfos();
        if (processEngineInfos.size() > 0) {
          message+="\nHowever " + processEngineInfos.size() + " other process engine(s) was found: ";
        }
        for (        ProcessEngineInfo processEngineInfo : processEngineInfos) {
          message+="Process engine '" + processEngineInfo.getName() + "' ("+ processEngineInfo.getResourceUrl()+ "):";
          if (processEngineInfo.getException() != null) {
            message+=processEngineInfo.getException();
          }
 else {
            message+="OK";
          }
        }
      }
      throw new WebScriptException(HttpServletResponse.SC_INTERNAL_SERVER_ERROR,message);
    }
  }
 catch (  JSONException e) {
    throw new WebScriptException(Status.STATUS_BAD_REQUEST,"Unable to parse JSON POST body: " + e.getMessage());
  }
catch (  IOException e) {
    throw new WebScriptException(Status.STATUS_INTERNAL_SERVER_ERROR,"Unable to retrieve POST body: " + e.getMessage());
  }
}
