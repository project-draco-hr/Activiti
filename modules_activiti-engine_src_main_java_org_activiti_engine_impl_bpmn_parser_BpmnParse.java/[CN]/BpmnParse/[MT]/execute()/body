{
  try {
    BpmnXMLConverter converter=new BpmnXMLConverter();
    boolean enableSafeBpmnXml=false;
    String encoding=null;
    if (Context.getProcessEngineConfiguration() != null) {
      enableSafeBpmnXml=Context.getProcessEngineConfiguration().isEnableSafeBpmnXml();
      encoding=Context.getProcessEngineConfiguration().getXmlEncoding();
    }
    if (encoding != null) {
      bpmnModel=converter.convertToBpmnModel(streamSource,true,enableSafeBpmnXml,encoding);
    }
 else {
      bpmnModel=converter.convertToBpmnModel(streamSource,true,enableSafeBpmnXml);
    }
    createImports();
    createItemDefinitions();
    createMessages();
    createOperations();
    transformProcessDefinitions();
  }
 catch (  Exception e) {
    if (e instanceof ActivitiException) {
      throw (ActivitiException)e;
    }
 else {
      throw new ActivitiException("Error parsing XML",e);
    }
  }
  if (bpmnModel.getProblems().size() > 0) {
    StringBuilder problemBuilder=new StringBuilder();
    for (    Problem error : bpmnModel.getProblems()) {
      problemBuilder.append(error.toString());
      problemBuilder.append("\n");
    }
    throw new ActivitiException("Errors while parsing:\n" + problemBuilder.toString());
  }
  return this;
}
