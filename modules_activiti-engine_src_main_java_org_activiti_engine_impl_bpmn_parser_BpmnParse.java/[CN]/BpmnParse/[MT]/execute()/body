{
  BpmnXMLConverter converter=new BpmnXMLConverter();
  XMLInputFactory xif=XMLInputFactory.newInstance();
  if (xif.isPropertySupported(XMLInputFactory.IS_REPLACING_ENTITY_REFERENCES)) {
    xif.setProperty(XMLInputFactory.IS_REPLACING_ENTITY_REFERENCES,false);
  }
  if (xif.isPropertySupported(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES)) {
    xif.setProperty(XMLInputFactory.IS_SUPPORTING_EXTERNAL_ENTITIES,false);
  }
  if (xif.isPropertySupported(XMLInputFactory.SUPPORT_DTD)) {
    xif.setProperty(XMLInputFactory.SUPPORT_DTD,false);
  }
  InputStreamReader in=null;
  try {
    in=new InputStreamReader(streamSource.getInputStream(),"UTF-8");
    XMLStreamReader xtr=xif.createXMLStreamReader(in);
    try {
      converter.validateModel(xtr);
      in=new InputStreamReader(streamSource.getInputStream(),"UTF-8");
      xtr=xif.createXMLStreamReader(in);
    }
 catch (    Exception e) {
      throw new ActivitiException("Could not validate XML with BPMN 2.0 XSD",e);
    }
    bpmnModel=converter.convertToBpmnModel(xtr);
    createImports();
    createItemDefinitions();
    createMessages();
    createOperations();
    transformProcessDefinitions();
  }
 catch (  Exception e) {
    if (e instanceof ActivitiException) {
      throw (ActivitiException)e;
    }
 else {
      throw new ActivitiException("Error parsing XML",e);
    }
  }
 finally {
    try {
      if (in != null) {
        in.close();
      }
    }
 catch (    Exception e) {
      LOGGER.info("Problem closing BPMN input stream",e);
    }
  }
  if (bpmnModel.getProblems().size() > 0) {
    StringBuilder problemBuilder=new StringBuilder();
    for (    Problem error : bpmnModel.getProblems()) {
      problemBuilder.append(error.toString());
      problemBuilder.append("\n");
    }
    throw new ActivitiException("Errors while parsing:\n" + problemBuilder.toString());
  }
  return this;
}
