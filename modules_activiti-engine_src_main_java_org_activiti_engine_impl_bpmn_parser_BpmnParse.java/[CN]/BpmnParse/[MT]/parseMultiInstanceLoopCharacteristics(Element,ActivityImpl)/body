{
  if (!(activity.getActivityBehavior() instanceof AbstractBpmnActivityBehavior)) {
    return;
  }
  Element miLoopCharacteristics=activityElement.element("multiInstanceLoopCharacteristics");
  if (miLoopCharacteristics != null) {
    boolean isSequential=parseBooleanAttribute(miLoopCharacteristics.attribute("isSequential"),false);
    MultiInstanceActivityBehavior miActivityBehavior=null;
    if (isSequential) {
      miActivityBehavior=new SequentialMultiInstanceBehavior((AbstractBpmnActivityBehavior)activity.getActivityBehavior());
    }
 else {
      miActivityBehavior=new ParallelMultiInstanceBehavior((AbstractBpmnActivityBehavior)activity.getActivityBehavior());
    }
    activity.setScope(true);
    activity.setActivityBehavior(miActivityBehavior);
    Element loopCardinality=miLoopCharacteristics.element("loopCardinality");
    if (loopCardinality != null) {
      String loopCardinalityText=loopCardinality.getText();
      if (loopCardinalityText == null || "".equals(loopCardinalityText)) {
        addError("loopCardinality must be defined for a multiInstanceLoopCharacteristics definition ",miLoopCharacteristics);
      }
      miActivityBehavior.setLoopCardinalityExpression(expressionManager.createExpression(loopCardinalityText));
    }
    Element completionCondition=miLoopCharacteristics.element("completionCondition");
    if (completionCondition != null) {
      String completionConditionText=completionCondition.getText();
      miActivityBehavior.setCompletionConditionExpression(expressionManager.createExpression(completionConditionText));
    }
    Element loopDataInputRef=miLoopCharacteristics.element("loopDataInputRef");
    if (loopDataInputRef != null) {
      String loopDataInputRefText=loopDataInputRef.getText();
      if (loopDataInputRefText != null) {
        if (loopDataInputRefText.contains("${")) {
          miActivityBehavior.setLoopDataInputRefExpression(expressionManager.createExpression(loopDataInputRefText));
        }
 else {
          miActivityBehavior.setLoopDataInputRefVariable(loopDataInputRefText);
        }
      }
    }
    Element inputDataItem=miLoopCharacteristics.element("inputDataItem");
    if (inputDataItem != null) {
      String inputDataItemName=inputDataItem.attribute("name");
      miActivityBehavior.setInputDataItemVariable(inputDataItemName);
    }
    if (miActivityBehavior.getLoopCardinalityExpression() == null && miActivityBehavior.getLoopDataInputRefExpression() == null && miActivityBehavior.getLoopDataInputRefVariable() == null) {
      addError("Either either loopCardinality or loopDataInputRef must been set",miLoopCharacteristics);
    }
    for (    BpmnParseListener parseListener : parseListeners) {
      parseListener.parseMultiInstanceLoopCharacteristics(activityElement,miLoopCharacteristics,activity);
    }
  }
}
