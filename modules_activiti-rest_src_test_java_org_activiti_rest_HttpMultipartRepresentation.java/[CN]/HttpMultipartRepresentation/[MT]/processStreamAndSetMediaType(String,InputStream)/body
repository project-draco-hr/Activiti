{
  ByteArrayOutputStream output=new ByteArrayOutputStream();
  IOUtils.copy(fileStream,output);
  final int length=output.toByteArray().length;
  final InputStream stream=new ByteArrayInputStream(output.toByteArray());
  MultipartRequestEntity entity=new MultipartRequestEntity(new Part[]{new FilePart(fileName,new PartSource(){
    @Override public long getLength(){
      return length;
    }
    @Override public String getFileName(){
      return fileName;
    }
    @Override public InputStream createInputStream() throws IOException {
      return stream;
    }
  }
)},new HttpMethodParams());
  ByteArrayOutputStream os=new ByteArrayOutputStream();
  entity.writeRequest(os);
  setMediaType(new MediaType(entity.getContentType()));
  setStream(new ByteArrayInputStream(os.toByteArray()));
}
