{
  ByteArrayOutputStream output=new ByteArrayOutputStream();
  IOUtils.copy(fileStream,output);
  final int length=output.toByteArray().length;
  final InputStream stream=new ByteArrayInputStream(output.toByteArray());
  List<Part> parts=new ArrayList<Part>();
  FilePart filePart=new FilePart(fileName,new PartSource(){
    @Override public long getLength(){
      return length;
    }
    @Override public String getFileName(){
      return fileName;
    }
    @Override public InputStream createInputStream() throws IOException {
      return stream;
    }
  }
);
  parts.add(filePart);
  if (additionalFormFields != null && !additionalFormFields.isEmpty()) {
    for (    Entry<String,String> field : additionalFormFields.entrySet()) {
      parts.add(new StringPart(field.getKey(),field.getValue()));
    }
  }
  MultipartRequestEntity entity=new MultipartRequestEntity(parts.toArray(new Part[]{}),new HttpMethodParams());
  ByteArrayOutputStream os=new ByteArrayOutputStream();
  entity.writeRequest(os);
  setMediaType(new MediaType(entity.getContentType()));
  setStream(new ByteArrayInputStream(os.toByteArray()));
}
