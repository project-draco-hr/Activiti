{
  String imageLocation="org/activiti/engine/test/bpmn/deployment/DiagramGenerationTest.testGeneratedDiagramMatchesExpected.png";
  BufferedImage expectedImage=ImageIO.read(ReflectUtil.getResourceAsStream(imageLocation));
  GraphicsEnvironment environment=GraphicsEnvironment.getLocalGraphicsEnvironment();
  GraphicsDevice device=environment.getDefaultScreenDevice();
  GraphicsConfiguration config=device.getDefaultConfiguration();
  BufferedImage compatibleImage=config.createCompatibleImage(expectedImage.getWidth(),expectedImage.getHeight(),Transparency.TRANSLUCENT);
  compatibleImage.createGraphics().drawImage(expectedImage,0,0,null);
  compatibleImage.flush();
  ProcessDefinition processDefinition=repositoryService.createProcessDefinitionQuery().singleResult();
  BufferedImage imageInRepo=ImageIO.read(repositoryService.getResourceAsStream(processDefinition.getDeploymentId(),processDefinition.getDiagramResourceName()));
  assertNotNull(imageInRepo);
  for (int x=0; x < compatibleImage.getWidth(); x++) {
    for (int y=0; y < compatibleImage.getHeight(); y++) {
      assertEquals(compatibleImage.getRGB(x,y),imageInRepo.getRGB(x,y));
    }
  }
}
