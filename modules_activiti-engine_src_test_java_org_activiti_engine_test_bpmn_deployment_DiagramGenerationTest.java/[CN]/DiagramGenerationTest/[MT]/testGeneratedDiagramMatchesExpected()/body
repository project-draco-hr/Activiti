{
  String imageLocation="org/activiti/engine/test/bpmn/deployment/DiagramGenerationTest.testGeneratedDiagramMatchesExpected.png";
  BufferedImage expectedImage=ImageIO.read(ReflectUtil.getResourceAsStream(imageLocation));
  ProcessDefinition processDefinition=repositoryService.createProcessDefinitionQuery().singleResult();
  BufferedImage imageInRepo=ImageIO.read(repositoryService.getResourceAsStream(processDefinition.getDeploymentId(),processDefinition.getDiagramResourceName()));
  assertNotNull(imageInRepo);
  assertTrue(expectedImage.getWidth() > 0);
  assertTrue(expectedImage.getHeight() > 0);
  assertEquals(expectedImage.getWidth(),imageInRepo.getWidth());
  assertEquals(expectedImage.getHeight(),imageInRepo.getHeight());
  for (int i=0; i < expectedImage.getWidth(); i++) {
    for (int j=0; j < expectedImage.getHeight(); j++) {
      setAlphaToWhite(expectedImage,i,j);
      setAlphaToWhite(imageInRepo,i,j);
      assertEquals(expectedImage.getRGB(i,j),imageInRepo.getRGB(i,j));
    }
  }
}
