{
  if (taskId != null) {
    TaskEntity task=Context.getCommandContext().getTaskEntityManager().findTaskById(taskId);
    if (task == null) {
      throw new ActivitiException("Cannot find task with id " + taskId);
    }
    if (task.isSuspended()) {
      throw new ActivitiException("It is not allowed to add an attachment to a suspended task");
    }
  }
  if (processInstanceId != null) {
    ExecutionEntity execution=commandContext.getExecutionEntityManager().findExecutionById(processInstanceId);
    if (execution == null) {
      throw new ActivitiException("Process instance " + processInstanceId + " doesn't exist");
    }
    if (execution.isSuspended()) {
      throw new ActivitiException("It is not allowed to add an attachment to a suspended process instance");
    }
  }
}
