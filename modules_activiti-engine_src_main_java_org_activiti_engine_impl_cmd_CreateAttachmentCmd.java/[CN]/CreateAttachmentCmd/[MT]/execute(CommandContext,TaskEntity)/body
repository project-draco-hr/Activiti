{
  AttachmentEntity attachment=new AttachmentEntity();
  attachment.setName(attachmentName);
  attachment.setDescription(attachmentDescription);
  attachment.setType(attachmentType);
  attachment.setTaskId(taskId);
  attachment.setProcessInstanceId(processInstanceId);
  attachment.setUrl(url);
  DbSqlSession dbSqlSession=commandContext.getDbSqlSession();
  dbSqlSession.insert(attachment);
  if (content != null) {
    byte[] bytes=IoUtil.readInputStream(content,attachmentName);
    ByteArrayEntity byteArray=new ByteArrayEntity(bytes);
    dbSqlSession.insert(byteArray);
    attachment.setContentId(byteArray.getId());
  }
  CommentManager commentManager=commandContext.getCommentManager();
  if (commentManager.isHistoryEnabled()) {
    String userId=Authentication.getAuthenticatedUserId();
    CommentEntity comment=new CommentEntity();
    comment.setUserId(userId);
    comment.setType(CommentEntity.TYPE_EVENT);
    comment.setTime(ClockUtil.getCurrentTime());
    comment.setTaskId(taskId);
    comment.setProcessInstanceId(processInstanceId);
    comment.setAction(Event.ACTION_ADD_ATTACHMENT);
    comment.setMessage(attachmentName);
    commentManager.insert(comment);
  }
  return attachment;
}
