{
  ensureCommandContextAvailable();
  HistoricProcessInstanceImpl historicProcessInstance=CommandContext.getCurrent().getPersistenceSession().findHistoricProcessInstance(event.getProcessInstanceId());
  if (historicProcessInstance == null) {
    String processInstanceId=event.getProcessInstanceId();
    String processDefinitionId=event.getProcessDefinitionId();
    Date startTime=ClockUtil.getCurrentTime();
    historicProcessInstance=new HistoricProcessInstanceImpl(processInstanceId,processDefinitionId,startTime);
  }
  Date endTime=ClockUtil.getCurrentTime();
  historicProcessInstance.markEnded(endTime,"endStateName");
  CommandContext.getCurrent().getPersistenceSession().saveHistoricProcessInstance(historicProcessInstance);
}
