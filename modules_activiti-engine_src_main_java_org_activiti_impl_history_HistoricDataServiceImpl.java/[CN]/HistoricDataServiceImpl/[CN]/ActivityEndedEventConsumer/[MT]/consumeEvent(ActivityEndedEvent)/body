{
  ensureCommandContextAvailable();
  HistoricActivityInstanceImpl historicActivityInstance=CommandContext.getCurrent().getPersistenceSession().findHistoricActivityInstance(event.getActivityId(),event.getProcessInstanceId());
  if (historicActivityInstance == null) {
    String activityId=event.getActivityId();
    String activityName=event.getPayload().getName();
    String activityType=event.getPayload().getType();
    String processInstanceId=event.getProcessInstanceId();
    String processDefinitionId=event.getProcessDefinitionId();
    Date startTime=ClockUtil.getCurrentTime();
    historicActivityInstance=new HistoricActivityInstanceImpl(activityId,activityName,activityType,processInstanceId,processDefinitionId,startTime);
  }
  historicActivityInstance.markEnded(ClockUtil.getCurrentTime());
  CommandContext.getCurrent().getPersistenceSession().saveHistoricActivityInstance(historicActivityInstance);
}
