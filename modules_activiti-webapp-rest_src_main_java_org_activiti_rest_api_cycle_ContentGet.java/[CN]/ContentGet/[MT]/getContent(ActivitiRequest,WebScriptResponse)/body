{
  CycleContentService contentService=CycleServiceFactory.getContentService();
  String cnonectorId=req.getMandatoryString("connectorId");
  String artifactId=req.getMandatoryString("artifactId");
  String contentRepresentationId=req.getMandatoryString("contentRepresentationId");
  RepositoryArtifact artifact=repositoryService.getRepositoryArtifact(cnonectorId,artifactId);
  ContentRepresentation contentRepresentation=contentService.getContentRepresentation(artifact,contentRepresentationId);
  MimeType contentType=contentRepresentation.getRepresentationMimeType();
  boolean attach=contentType.getName().startsWith("application/") ? true : false;
  String attachmentFileName=null;
  if (attach) {
    attachmentFileName=artifact.getMetadata().getName();
    if (contentType.equals(CycleApplicationContext.get(XmlMimeType.class)) && !attachmentFileName.endsWith(".xml")) {
      attachmentFileName+=".xml";
    }
 else     if (contentType.equals(CycleApplicationContext.get(JsonMimeType.class)) && !attachmentFileName.endsWith(".json")) {
      attachmentFileName+=".json";
    }
 else     if (contentType.equals(CycleApplicationContext.get(TextMimeType.class)) && !attachmentFileName.endsWith(".txt")) {
      attachmentFileName+=".txt";
    }
 else     if (contentType.equals(CycleApplicationContext.get(PdfMimeType.class)) && !attachmentFileName.endsWith(".pdf")) {
      attachmentFileName+=".pdf";
    }
 else     if (contentType.equals(CycleApplicationContext.get(MsExcelMimeType.class)) && !attachmentFileName.endsWith(".xls")) {
      attachmentFileName+=".xls";
    }
 else     if (contentType.equals(CycleApplicationContext.get(MsPowerpointMimeType.class)) && !attachmentFileName.endsWith(".ppt")) {
      attachmentFileName+=".ppt";
    }
 else     if (contentType.equals(CycleApplicationContext.get(MsWordMimeType.class)) && !attachmentFileName.endsWith(".doc")) {
      attachmentFileName+=".doc";
    }
  }
  InputStream contentInputStream=null;
  try {
    contentInputStream=contentRepresentation.getContent(artifact).asInputStream();
    MessageDigest md=MessageDigest.getInstance("MD5");
    byte[] messageDigest=md.digest(contentRepresentation.getContent(artifact).asByteArray());
    BigInteger number=new BigInteger(1,messageDigest);
    String etag=number.toString(16);
    while (etag.length() < 32) {
      etag="0" + etag;
    }
    String requestEtag=req.getHttpServletRequest().getHeader("If-None-Match");
    if (requestEtag != null) {
      requestEtag=requestEtag.replace("\"","");
    }
    if (etag.equals(requestEtag)) {
      throw new WebScriptException(HttpServletResponse.SC_NOT_MODIFIED,"");
    }
 else {
      streamResponse(res,contentInputStream,new Date(0),etag,attach,attachmentFileName,contentType.getName());
    }
  }
 catch (  TransformationException e) {
    streamResponse(res,new ByteArrayInputStream(e.getRenderContent().getBytes()),new Date(0),"",false,null,CycleApplicationContext.get(HtmlMimeType.class).getName());
  }
catch (  NoSuchAlgorithmException e) {
  }
 finally {
    IoUtil.closeSilently(contentInputStream);
  }
}
