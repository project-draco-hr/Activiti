{
  ProcessInstance pi=runtimeService.startProcessInstanceByKey("ProcessWithSubProcess");
  Task task=taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();
  Map<String,Object> variables=new HashMap<String,Object>();
  variables.put("test","1");
  taskService.complete(task.getId(),variables);
  task=taskService.createTaskQuery().processInstanceId(pi.getId()).singleResult();
  variables.clear();
  variables.put("test","2");
  taskService.complete(task.getId(),variables);
  assertProcessEnded(pi.getId());
  List<HistoricDetail> updates=historyService.createHistoricDetailQuery().variableUpdates().list();
  assertEquals(2,updates.size());
  HistoricVariableUpdate update1=(HistoricVariableUpdate)updates.get(0);
  HistoricVariableUpdate update2=(HistoricVariableUpdate)updates.get(1);
  assertEquals("1",update1.getValue());
  assertEquals("2",update2.getValue());
  assertNotNull(update1.getActivityInstanceId());
  assertNotNull(update1.getExecutionId());
  HistoricActivityInstance historicActivityInstance1=historyService.createHistoricActivityInstanceQuery().activityInstanceId(update1.getActivityInstanceId()).singleResult();
  assertEquals(historicActivityInstance1.getExecutionId(),update1.getExecutionId());
  assertEquals("usertask1",historicActivityInstance1.getActivityId());
}
