{
  ProcessDefinitionEntity processDefinition=Context.getProcessEngineConfiguration().getDeploymentCache().findDeployedProcessDefinitionById(processDefinitionId);
  if (processDefinition == null) {
    throw new ActivitiException("No process definition found for id = '" + processDefinitionId + "'");
  }
  ExecutionEntity processInstance=null;
  if (businessKey != null) {
    processInstance=processDefinition.createProcessInstance(businessKey);
  }
 else {
    processInstance=processDefinition.createProcessInstance();
  }
  if (commandContext.getHistoryManager().isHistoryLevelAtLeast(HistoryLevel.AUDIT)) {
    DbSqlSession dbSqlSession=commandContext.getSession(DbSqlSession.class);
    for (    String propertyId : properties.keySet()) {
      String propertyValue=properties.get(propertyId);
      HistoricFormPropertyEntity historicFormProperty=new HistoricFormPropertyEntity(processInstance,propertyId,propertyValue);
      dbSqlSession.insert(historicFormProperty);
    }
  }
  StartFormHandler startFormHandler=processDefinition.getStartFormHandler();
  startFormHandler.submitFormProperties(properties,processInstance);
  processInstance.start();
  return processInstance;
}
