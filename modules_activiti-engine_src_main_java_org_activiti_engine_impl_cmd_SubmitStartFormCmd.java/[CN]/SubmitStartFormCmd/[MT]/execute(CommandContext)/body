{
  RepositorySession repositorySession=commandContext.getRepositorySession();
  ProcessDefinitionEntity processDefinition=repositorySession.findDeployedProcessDefinitionById(processDefinitionId);
  if (processDefinition == null) {
    throw new ActivitiException("No process definition found for id = '" + processDefinitionId + "'");
  }
  ExecutionEntity processInstance=null;
  processInstance=processDefinition.createProcessInstance();
  int historyLevel=Context.getProcessEngineConfiguration().getHistoryLevel();
  if (historyLevel >= ProcessEngineConfigurationImpl.HISTORYLEVEL_ACTIVITY) {
    DbSqlSession dbSqlSession=commandContext.getSession(DbSqlSession.class);
    if (historyLevel >= ProcessEngineConfigurationImpl.HISTORYLEVEL_AUDIT) {
      for (      String propertyId : properties.keySet()) {
        String propertyValue=properties.get(propertyId);
        HistoricFormPropertyEntity historicFormProperty=new HistoricFormPropertyEntity(processInstance,propertyId,propertyValue);
        dbSqlSession.insert(historicFormProperty);
      }
    }
  }
  StartFormHandler startFormHandler=processDefinition.getStartFormHandler();
  startFormHandler.submitFormProperties(properties,processInstance);
  processInstance.start();
  return processInstance;
}
