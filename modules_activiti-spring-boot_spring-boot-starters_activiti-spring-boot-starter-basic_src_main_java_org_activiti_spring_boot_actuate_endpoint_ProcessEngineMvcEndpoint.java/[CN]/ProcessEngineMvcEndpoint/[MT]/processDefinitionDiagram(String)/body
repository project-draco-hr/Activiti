{
  List processDefinitions=repositoryService.createProcessDefinitionQuery().processDefinitionKey(processDefinitionKey).orderByProcessDefinitionVersion().desc().list();
  if (processDefinitions.isEmpty()) {
    return ResponseEntity.status(NOT_FOUND).body(null);
  }
  ProcessDefinition processDefinition=(ProcessDefinition)processDefinitions.get(0);
  ProcessDiagramGenerator processDiagramGenerator=new DefaultProcessDiagramGenerator();
  BpmnModel bpmnModel=repositoryService.getBpmnModel(processDefinition.getId());
  if (bpmnModel.getLocationMap().size() == 0) {
    BpmnAutoLayout autoLayout=new BpmnAutoLayout(bpmnModel);
    autoLayout.execute();
  }
  InputStream is=processDiagramGenerator.generateJpgDiagram(bpmnModel);
  return ResponseEntity.ok(new InputStreamResource(is));
}
