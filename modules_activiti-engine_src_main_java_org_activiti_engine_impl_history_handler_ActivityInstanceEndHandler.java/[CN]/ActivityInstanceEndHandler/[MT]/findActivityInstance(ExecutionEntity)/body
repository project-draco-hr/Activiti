{
  CommandContext commandContext=CommandContext.getCurrent();
  String executionId=execution.getId();
  String activityId=execution.getActivityId();
  DbSqlSession dbSqlSession=commandContext.getDbSqlSession();
  List<HistoricActivityInstanceEntity> cachedHistoricActivityInstances=dbSqlSession.findInCache(HistoricActivityInstanceEntity.class);
  for (  HistoricActivityInstanceEntity cachedHistoricActivityInstance : cachedHistoricActivityInstances) {
    if (executionId.equals(cachedHistoricActivityInstance.getExecutionId()) && (activityId.equals(cachedHistoricActivityInstance.getActivityId())) && (cachedHistoricActivityInstance.getEndTime() == null)) {
      return cachedHistoricActivityInstance;
    }
  }
  List<HistoricActivityInstance> historicActivityInstances=new HistoricActivityInstanceQueryImpl().executionId(executionId).activityId(activityId).onlyOpen().executeList(commandContext,new Page(0,1));
  if (!historicActivityInstances.isEmpty()) {
    return (HistoricActivityInstanceEntity)historicActivityInstances.get(0);
  }
  if (execution.getParentId() != null) {
    return findActivityInstance((ExecutionEntity)execution.getParent());
  }
  throw new ActivitiException("no existing history activity entity found for execution " + executionId + " in activity "+ activityId);
}
